<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Checklist de Oficina - App Offline com PDF">
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.jpg">
    <link rel="icon" type="image/png" href="logo.jpg">
   <title id="titulo-pagina">Checklist de Entrada ‚Äì Oficina</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
       <div class="header">
    <div class="logo-container">
        <img id="logo-oficina" src="logo.jpg" alt="Logo da Oficina">
    </div>
    <div class="header-content">
        <!-- ‚úÖ NEUTRO - PREENCHER NO CONFIG.JS -->
        <h1 id="nome-oficina">OFICINA</h1>
        <p id="subtitulo-oficina">Checklist de entrada e inspe√ß√£o veicular</p>
        <div class="contato-info">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" class="whatsapp-icon">
            <span id="telefone-oficina">(00) 00000-0000</span>
        </div>
        <div class="endereco-oficina" id="endereco-oficina">
            ENDERE√áO DA OFICINA
        </div>
        <div class="cnpj-oficina" id="cnpj-oficina">
    CNPJ: 00.000.000/0000-00
</div>


                <div class="status-sync">
                    <div class="sync-dot" id="syncStatus"></div>
                    <span id="syncText">Online</span>
                </div>
            </div>
            <div class="header-badge">v3.0 PRO</div>
        </div>
<div class="tabs">
    <button class="tab-button active" onclick="switchTab('novo-checklist')">‚ûï Novo Checklist</button>
    <button class="tab-button" onclick="switchTab('orcamento')">üí∞ Pe√ßas & Servi√ßos</button>
    <button class="tab-button" onclick="switchTab('fotos')">üì∏ Fotos</button>
    <button class="tab-button" onclick="switchTab('historico')">üìã Hist√≥rico</button>
    <button class="tab-button" onclick="switchTab('relatorios')">üìä Relat√≥rios</button>
</div>


        <!-- ABA PRINCIPAL - CHECKLIST -->
        <div id="novo-checklist" class="tab-content active">
            <div class="content">
                <div id="successMessage" class="alert alert-success"></div>
                <div id="errorMessage" class="alert alert-error"></div>
                <div id="infoMessage" class="alert alert-info"></div>

                <form id="checklistForm">
                    <div class="section-title">üìã INFORMA√á√ïES DO VE√çCULO</div>

                    <!-- RESUMO FIXO DO VE√çCULO (VISUAL) -->
                    <div class="veiculo-resumo" id="resumoVeiculoPrincipal">
                        <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca">-</strong></div>
                        <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo">-</strong></div>
                        <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi">-</strong></div>
                        <div class="veiculo-resumo-pill">KM Entrada: <strong id="resumoKmEntrada">-</strong></div>
                        <div class="veiculo-resumo-pill">Data Entrada: <strong id="resumoData">-</strong></div>
                        <div class="veiculo-resumo-pill">Hora Entrada: <strong id="resumoHora">-</strong></div>
                        <div class="veiculo-resumo-pill">Combust√≠vel: <strong id="resumoCombustivel">-</strong></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="placa">Placa *</label>
                            <input type="text" id="placa" name="placa" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="chassi">Chassi</label>
                            <input type="text" id="chassi" name="chassi" placeholder="17 d√≠gitos" maxlength="17">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modelo">Modelo</label>
                            <input type="text" id="modelo" name="modelo" placeholder="Ex: Fiat Uno">
                        </div>
                        <div class="form-group">
                            <label for="km_entrada">KM Entrada</label>
                            <input type="text" id="km_entrada" name="km_entrada" placeholder="150.000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="data">Data Entrada</label>
                            <input type="date" id="data" name="data">
                        </div>
                        <div class="form-group">
                            <label for="hora">Hora Entrada</label>
                            <input type="time" id="hora" name="hora">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="combustivel">N√≠vel Combust√≠vel</label>
                            <select id="combustivel" name="combustivel">
                                <option value="">Selecione...</option>
                                <option value="cheio">Cheio</option>
                                <option value="meio">Meio</option>
                                <option value="1/4">1/4</option>
                                <option value="vazio">Vazio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="km_saida">KM Sa√≠da</label>
                            <input type="text" id="km_saida" name="km_saida" placeholder="150.500">
                        </div>
                    </div>

                    <div class="section-title">üöó CARACTER√çSTICAS DO VE√çCULO</div>

                    <div class="equip-section">
                        <div class="equip-section-title">üîß ACESS√ìRIOS OBRIGAT√ìRIOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="estepe" name="equipamentos" value="ESTEPE"><label for="estepe">ESTEPE</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="macaco" name="equipamentos" value="MACACO"><label for="macaco">MACACO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="chave_roda" name="equipamentos" value="CHAVE DE RODA"><label for="chave_roda">CHAVE DE RODA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="triangulo" name="equipamentos" value="TRI√ÇNGULO"><label for="triangulo">TRI√ÇNGULO</label></div>
                        </div>
                    </div>

<div class="equip-section">
    <div class="equip-section-title">‚õΩ TIPO COMBUST√çVEL</div>
    <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="gasolina" name="equipamentos" value="GASOLINA"><label for="gasolina">GASOLINA</label></div>
        <div class="checkbox-item"><input type="checkbox" id="etanol" name="equipamentos" value="ETANOL"><label for="etanol">ETANOL</label></div>
        <div class="checkbox-item"><input type="checkbox" id="gnv" name="equipamentos" value="GNV"><label for="gnv">GNV</label></div>
        <div class="checkbox-item"><input type="checkbox" id="diesel" name="equipamentos" value="DIESEL"><label for="diesel">DIESEL</label></div>
    </div>
</div>



                    <div class="equip-section">
                        <div class="equip-section-title">üîä ELETR√îNICOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="radio" name="equipamentos" value="R√ÅDIO / MULTIM√çDIA"><label for="radio">R√ÅDIO / MULTIM√çDIA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="alarme_corta" name="equipamentos" value="ALARME / CORTA CORRENTE"><label for="alarme_corta">ALARME / CORTA CORRENTE</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="antena" name="equipamentos" value="ANTENA"><label for="antena">ANTENA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="acendedor" name="equipamentos" value="ACENDEDOR/TOMADA 12V"><label for="acendedor">ACENDEDOR/TOMADA 12V</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
                        <div class="equip-section-title">‚ö° EL√âTRICOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="vidro_eletrico" name="equipamentos" value="VIDRO EL√âTRICO"><label for="vidro_eletrico">VIDRO EL√âTRICO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="trava_eletrica" name="equipamentos" value="TRAVA EL√âTRICA"><label for="trava_eletrica">TRAVA EL√âTRICA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="buzina" name="equipamentos" value="BUZINA"><label for="buzina">BUZINA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="bateria" name="equipamentos" value="BATERIA"><label for="bateria">BATERIA</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
                        <div class="equip-section-title">üõû RODAS & P√ÅRA-BRISAS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="calotas" name="equipamentos" value="CALOTAS"><label for="calotas">CALOTAS</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rodas_liga" name="equipamentos" value="RODAS DE LIGA"><label for="rodas_liga">RODAS DE LIGA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="roda_ferro" name="equipamentos" value="RODA DE FERRO"><label for="roda_ferro">RODA DE FERRO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="para_brisa" name="equipamentos" value="PARABRISA TRINCADO"><label for="para_brisa">P√ÅRA BRISA TRICADO</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
    <div class="equip-section-title">üì¶ DEMAIS ACESS√ìRIOS</div>
    <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="extintor" name="equipamentos" value="EXTINTOR"><label for="extintor">EXTINTOR</label></div>
        <div class="checkbox-item"><input type="checkbox" id="protetor_carter" name="equipamentos" value="PROTETOR DE CARTER"><label for="protetor_carter">PROTETOR DE CARTER</label></div>
        <div class="checkbox-item"><input type="checkbox" id="chave_secreta" name="equipamentos" value="CHAVE SEGREDO (RODA)"><label for="chave_secreta">CHAVE SEGREDO (RODA)</label></div>
        <div class="checkbox-item"><input type="checkbox" id="tapetes" name="equipamentos" value="TAPETES"><label for="tapetes">TAPETES</label></div>
    </div>
</div>


                    <div class="equip-section">
                        <div class="equip-section-title">‚≠ê EQUIPAMENTOS PRINCIPAIS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="ar" name="caracteristicas" value="AR"><label for="ar">AR</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="abs" name="caracteristicas" value="ABS"><label for="abs">ABS</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="airbag" name="caracteristicas" value="Air Bag"><label for="airbag">Air Bag</label></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>C√¢mbio</label>
                            <div class="checkbox-group" style="margin-top: 5px;">
                                <div class="checkbox-item"><input type="checkbox" id="cambio_auto" name="cambio" value="Autom√°tico"><label for="cambio_auto">Autom√°tico</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="cambio_manual" name="cambio" value="Manual"><label for="cambio_manual">Manual</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tra√ß√£o</label>
                            <div class="checkbox-group" style="margin-top: 5px;">
                                <div class="checkbox-item"><input type="checkbox" id="tracao_4x2" name="tracao" value="4x2"><label for="tracao_4x2">4x2</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="tracao_4x4" name="tracao" value="4x4"><label for="tracao_4x4">4x4</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">üë§ DADOS DO CLIENTE</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_cliente">Nome *</label>
                            <input type="text" id="nome_cliente" name="nome_cliente" placeholder="Nome completo do cliente">
                        </div>
                        <div class="form-group">
                            <label for="cpf_cnpj">CPF / CNPJ</label>
                            <input type="text" id="cpf_cnpj" name="cpf_cnpj" placeholder="000.000.000-00" maxlength="18">
                        </div>
                    </div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="endereco_cliente">Endere√ßo Completo</label>
                            <textarea id="endereco_cliente" name="endereco_cliente" placeholder="Rua, n√∫mero, bairro, cidade - UF, CEP" style="height: 60px; min-height: 60px;"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="celular_cliente">Celular / WhatsApp *</label>
                            <input type="tel" id="celular_cliente" name="celular_cliente" placeholder="(31) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label for="telefone2">Telefone 2 (opcional)</label>
                            <input type="tel" id="telefone2" name="telefone2" placeholder="(31) 9999-9999">
                        </div>
                    </div>

                    <div class="section-title">üîß SERVI√áOS/SOLICITADOS</div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="servicos">Descreva os servi√ßos solicitados:</label>
                            <textarea id="servicos" name="servicos" placeholder="Ex: Troca de √≥leo e filtro, alinhamento e balanceamento..."></textarea>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" class="btn-success" onclick="gerarPDF()">üìÑ Gerar PDF</button>
                        <button type="button" class="btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ABA HIST√ìRICO -->
        <div id="historico" class="tab-content">
            <div class="content">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por placa, modelo ou cliente..." onkeyup="filtrarChecklists()">
                    <button class="btn-secondary btn-small" onclick="ordenarChecklists()">üìä Ordenar</button>
                </div>

                <div id="checklistsList"></div>
                <div id="emptyMessage" style="text-align: center; padding: 40px; color: #999;">
                    <p style="font-size: 40px; margin-bottom: 10px;">üì≠</p>
                    <p>Nenhum checklist salvo ainda. Crie um novo para come√ßar!</p>
                </div>
            </div>
        </div>

        <!-- ABA RELAT√ìRIOS -->
        <div id="relatorios" class="tab-content">
            <div class="content">
                <div class="section-title">üìä ESTAT√çSTICAS GERAIS</div>
                <div class="stats-box">
                    <div class="stat-card">
                        <div class="stat-number" id="totalChecklists">0</div>
                        <div class="stat-label">Checklists Salvos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="checklistsMes">0</div>
                        <div class="stat-label">Checklists M√™s Atual</div>
                    </div>
                </div>

                <div class="section-title">üöó MARCAS MAIS ATENDIDAS</div>
                <div id="graficoMarcas" style="margin-top: 20px;"></div>

                <div class="action-buttons">
                    <button class="btn-primary" onclick="exportarDados()">üíæ Exportar Todos (JSON)</button>
                    <button class="btn-danger" onclick="limparTodosDados()">üóëÔ∏è Limpar Hist√≥rico</button>
                </div>
            </div>
        </div>

        <!-- ABA OR√áAMENTO ‚Äì PLANILHA DE PE√áAS & SERVI√áOS -->
        <div id="orcamento" class="tab-content">
            <div class="content">
                <div class="section-title">üí∞ PE√áAS & SERVI√áOS</div>

                <!-- RESUMO FIXO DO VE√çCULO TAMB√âM NA ABA DE PE√áAS -->
                <div class="veiculo-resumo" id="resumoVeiculoOrcamento">
                    <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca2">-</strong></div>
                    <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo2">-</strong></div>
                    <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi2">-</strong></div>
                    <div class="veiculo-resumo-pill">KM Entrada: <strong id="resumoKmEntrada2">-</strong></div>
                    <div class="veiculo-resumo-pill">Complexidade: <strong id="resumoComplexidade">-</strong></div>
                </div>

                <!-- COMPLEXIDADE -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="complexidade">Tipo de evento</label>
                        <select id="complexidade" name="complexidade">
                            <option value="">Selecione...</option>
                            <option value="Evento pequeno">Evento pequeno</option>
                            <option value="Evento m√©dio">Evento m√©dio</option>
                            <option value="Evento grande">Evento grande</option>
                        </select>
                    </div>
                </div>

              <!-- DENTRO DA DIV #orcamento -->

<!-- 1. Adicione a sele√ß√£o de Tipo (Pe√ßa ou Servi√ßo) no formul√°rio -->
<div class="form-row">
    <div class="form-group">
        <label>Tipo do Item:</label>
        <div class="checkbox-group" style="margin-top: 5px;">
            <div class="checkbox-item">
                <input type="radio" id="tipoPeca" name="tipoItem" value="peca" checked>
                <label for="tipoPeca">Pe√ßa</label>
            </div>
            <div class="checkbox-item">
                <input type="radio" id="tipoServico" name="tipoItem" value="servico">
                <label for="tipoServico">Servi√ßo</label>
            </div>
        </div>
    </div>
</div>

<div class="form-row two">
    <div class="form-group">
        <label for="descricaoItem">Descri√ß√£o</label>
        <input type="text" id="descricaoItem" placeholder="Ex: Pastilha de Freio / M√£o de obra">
    </div>
    <div class="form-group">
        <label for="valorItem">Valor (R$)</label>
        <input type="number" id="valorItem" step="0.01" min="0" placeholder="0,00">
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <button type="button" class="btn-primary" onclick="adicionarItemManual()">‚ûï Adicionar</button>
    </div>
</div>

<!-- 2. Substitua a tabela antiga por DUAS tabelas novas -->
<div style="margin-top:20px;">
    
    <!-- SE√á√ÉO DE PE√áAS -->
    <h4 style="border-bottom: 2px solid #e41616; padding-bottom: 5px; color: #333;">üî© Pe√ßas</h4>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom: 10px;">
        <thead>
            <tr style="background:#f7f7f7;">
                <th style="border:1px solid #ddd; padding:6px; text-align:left;">Descri√ß√£o</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width: 100px;">Valor</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width: 50px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaPecas"></tbody>
        <tfoot>
            <tr>
                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">Total Pe√ßas:</td>
                <td id="totalPecas" style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold; color: #e41616;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- SE√á√ÉO DE SERVI√áOS -->
    <h4 style="border-bottom: 2px solid #0056b3; padding-bottom: 5px; color: #333; margin-top: 25px;">üîß Servi√ßos</h4>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom: 10px;">
        <thead>
            <tr style="background:#f7f7f7;">
                <th style="border:1px solid #ddd; padding:6px; text-align:left;">Descri√ß√£o</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width: 100px;">Valor</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width: 50px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaServicos"></tbody>
        <tfoot>
            <tr>
                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">Total Servi√ßos:</td>
                <td id="totalServicos" style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold; color: #0056b3;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- TOTAL GERAL (SOMA DOS DOIS) -->
    <div style="background: #eee; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: right;">
        <span style="font-size: 14px; font-weight: bold; color: #555;">TOTAL GERAL (Pe√ßas + Servi√ßos):</span>
        <div id="totalGeralFinal" style="font-size: 24px; font-weight: bold; color: #28a745;">R$ 0,00</div>
    </div>

</div>
                <div class="action-buttons">
                    <button type="button" class="btn-success" onclick="gerarPDF()">üìÑ Gerar PDF</button>
                </div>
            </div>
        </div>
<!-- ABA FOTOS ‚úÖ PERFEITA -->
<div id="fotos" class="tab-content">
    <div class="content">
        <div class="section-title">üì∏ FOTOS DO VE√çCULO</div>
        
        <!-- RESUMO VE√çCULO -->
        <div class="veiculo-resumo" id="resumoVeiculoFotos">
            <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca3">-</strong></div>
            <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo3">-</strong></div>
            <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi3">-</strong></div>
            <div class="veiculo-resumo-pill">KM: <strong id="resumoKmFotos">-</strong></div>
        </div>

        <!-- BOT√ïES -->
        <div class="form-row">
            <div class="form-group">
                <button type="button" class="btn-primary" onclick="iniciarCamera()">üì∑ Tirar Foto</button>
            </div>
            <div class="form-group">
                <input type="file" id="uploadFotos" multiple accept="image/*" onchange="adicionarFotos(event)">
                <label for="uploadFotos" class="btn-secondary" style="cursor:pointer; padding:12px 24px; display:block; text-align:center;">üìÅ Galeria</label>
            </div>
        </div>

        <!-- C√ÇMERA -->
        <div class="camera-container" style="display:none;">
            <video id="cameraPreview" autoplay playsinline style="width:100%; max-width:400px; height:300px; border-radius:12px; border:3px solid #e41616; background:#000;"></video>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                <button class="btn-success btn-small" onclick="tirarFoto()" id="btnTirarFoto" style="display:none;">üì∏ Capturar</button>
                <button class="btn-secondary btn-small" onclick="pararCamera()">‚ùå Cancelar</button>
            </div>
        </div>

        <!-- GALERIA -->
        <div class="section-title">Galeria de Fotos (M√°x 15)</div>
        <div id="galeriaFotos" class="fotos-grid"></div>

        <div class="action-buttons">
            <button type="button" class="btn-success" onclick="gerarPDFFotos()">üìÑ PDF Fotos</button>
            <button type="button" class="btn-danger" onclick="limparFotos()">üóëÔ∏è Limpar Fotos</button>
        </div>
    </div>
</div>

    </div>
<!-- ======================================================
     CONTAINER OCULTO PARA GERAR PDF (ORDEM DE SERVI√áO)
====================================================== -->
<div id="containerPDF" style="display:none; width:210mm; background:#fff;">
  <div style="padding:18px 18px 12px 18px; border-bottom:4px solid var(--color-primary); display:flex; gap:16px; align-items:flex-start;">
    <div style="width:90px; flex:0 0 90px;">
      <img id="pdfLogo" src="logo.jpg" alt="Logo" style="width:100%; height:auto; object-fit:contain;">
    </div>
    <div style="flex:1;">
      <div id="pdfOficinaNome" style="font-size:20px; font-weight:800; color:var(--color-primary); line-height:1.1;">OFICINA</div>
      <div id="pdfOficinaSubtitulo" style="margin-top:4px; font-size:11px; color:#666;">Checklist de entrada e inspe√ß√£o veicular</div>
      <div style="margin-top:8px; font-size:11px; color:#444; line-height:1.5;">
        <div>üì± <span id="pdfOficinaTelefone">(00) 00000-0000</span></div>
        <div><span id="pdfOficinaEndereco">ENDERE√áO DA OFICINA</span></div>
        <div><span id="pdfOficinaCNPJ">CNPJ: --</span></div>
      </div>
    </div>
    <div style="text-align:right; flex:0 0 auto;">
      <div style="display:inline-block; background:var(--color-primary); color:#fff; padding:10px 12px; border-radius:8px; font-weight:800; font-size:12px;">
        OS N¬∫ <span id="pdfOSNumero">--</span>
      </div>
      <div style="margin-top:6px; font-size:10px; color:#666; line-height:1.4;">
        <div>Data: <span id="pdfGeradoData">--/--/----</span></div>
        <div>Hora: <span id="pdfGeradoHora">--:--</span></div>
      </div>
    </div>
  </div>

  <div style="padding:14px 18px; background:#fafafa; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
    <div style="background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px;">
      <div style="font-weight:800; font-size:11px; color:var(--color-primary); padding-bottom:8px; border-bottom:2px solid var(--color-primary);">CLIENTE</div>
      <div style="margin-top:8px; font-size:11px; color:#333; line-height:1.6;">
        <div><b>Nome:</b> <span id="pdfClienteNome">-</span></div>
        <div><b>CPF/CNPJ:</b> <span id="pdfClienteDoc">-</span></div>
        <div><b>Tel:</b> <span id="pdfClienteTel">-</span></div>
        <div><b>Endere√ßo:</b> <span id="pdfClienteEndereco">-</span></div>
      </div>
    </div>

    <div style="background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px;">
      <div style="font-weight:800; font-size:11px; color:var(--color-primary); padding-bottom:8px; border-bottom:2px solid var(--color-primary);">VE√çCULO</div>
      <div style="margin-top:8px; font-size:11px; color:#333; line-height:1.6;">
        <div><b>Placa:</b> <span id="pdfVeiculoPlaca">-</span></div>
        <div><b>Modelo:</b> <span id="pdfVeiculoModelo">-</span></div>
        <div><b>Chassi:</b> <span id="pdfVeiculoChassi">-</span></div>
        <div><b>KM Entrada:</b> <span id="pdfVeiculoKM">-</span></div>
        <div><b>Entrada:</b> <span id="pdfVeiculoEntrada">-</span></div>
        <div><b>Combust√≠vel:</b> <span id="pdfVeiculoCombustivel">-</span></div>
      </div>
    </div>
  </div>

  <div style="padding:14px 18px;">
    <div style="background:var(--color-primary); color:#fff; padding:10px 12px; border-radius:8px; font-size:12px; font-weight:800;">SERVI√áOS SOLICITADOS</div>
    <div id="pdfServicos" style="margin-top:10px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; font-size:11px; color:#333; min-height:52px; white-space:pre-wrap; line-height:1.5;">-</div>
  </div>

  <div style="padding:14px 18px;">
    <div style="background:var(--color-primary); color:#fff; padding:10px 12px; border-radius:8px; font-size:12px; font-weight:800;">INSPE√á√ÉO DE ENTRADA</div>
    <div id="pdfInspecaoGrid" style="margin-top:10px; display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;"></div>
  </div>

  <div style="padding:14px 18px;">
    <div style="font-weight:800; font-size:11px; color:var(--color-primary); padding-bottom:8px; border-bottom:2px solid var(--color-primary);">ITENS (PE√áAS E SERVI√áOS)</div>
    <div style="margin-top:10px;">
      <div style="font-weight:800; font-size:11px; color:#333; margin-bottom:6px;">üî© Pe√ßas</div>
      <table style="width:100%; border-collapse:collapse; font-size:11px;">
        <thead><tr style="background:#f3f3f3;"><th style="border:1px solid #ddd; padding:7px; text-align:left;">Descri√ß√£o</th><th style="border:1px solid #ddd; padding:7px; text-align:right; width:95px;">Valor</th></tr></thead>
        <tbody id="pdfPecasBody"></tbody>
        <tfoot><tr><td style="border:1px solid #ddd; padding:7px; text-align:right; font-weight:800;">Total Pe√ßas:</td><td id="pdfTotalPecas" style="border:1px solid #ddd; padding:7px; text-align:right; font-weight:800; color:var(--color-primary);">R$ 0,00</td></tr></tfoot>
      </table>
    </div>
    <div style="margin-top:14px;">
      <div style="font-weight:800; font-size:11px; color:#333; margin-bottom:6px;">üîß Servi√ßos</div>
      <table style="width:100%; border-collapse:collapse; font-size:11px;">
        <thead><tr style="background:#f3f3f3;"><th style="border:1px solid #ddd; padding:7px; text-align:left;">Descri√ß√£o</th><th style="border:1px solid #ddd; padding:7px; text-align:right; width:95px;">Valor</th></tr></thead>
        <tbody id="pdfServicosBody"></tbody>
        <tfoot><tr><td style="border:1px solid #ddd; padding:7px; text-align:right; font-weight:800;">Total Servi√ßos:</td><td id="pdfTotalServicos" style="border:1px solid #ddd; padding:7px; text-align:right; font-weight:800; color:#0056b3;">R$ 0,00</td></tr></tfoot>
      </table>
    </div>
    <div style="margin-top:14px; padding:12px; border-radius:10px; background:#efefef; text-align:right;">
      <div style="font-size:11px; color:#555; font-weight:800;">TOTAL GERAL (Pe√ßas + Servi√ßos):</div>
      <div id="pdfTotalGeral" style="font-size:18px; font-weight:900; color:#27ae60; margin-top:4px;">R$ 0,00</div>
    </div>
  </div>

  <div style="padding:18px; display:grid; grid-template-columns:1fr 1fr; gap:18px;">
    <div style="border-top:2px solid #000; padding-top:6px; text-align:center; font-size:10px; color:#333;">Assinatura do Cliente</div>
    <div style="border-top:2px solid #000; padding-top:6px; text-align:center; font-size:10px; color:#333;">Respons√°vel pela Inspe√ß√£o</div>
  </div>
  <div style="padding:12px 18px 18px 18px; text-align:center; font-size:9px; color:#666; border-top:1px solid #eee;">
    Gerado em <span id="pdfGeradoDataHora">--/--/---- --:--</span>
  </div>
</div>


    <script>
function salvarChecklist() {

    const dados = {};

    document.querySelectorAll('input, select, textarea').forEach(el => {

        if (!el.name && !el.id) return;

        const chave = el.name || el.id;

        if (el.type === 'checkbox') {
            dados[chave] = el.checked;
        } else if (el.type === 'radio') {
            if (el.checked) dados[chave] = el.value;
        } else {
            dados[chave] = el.value;
        }
    });

    // pe√ßas adicionadas dinamicamente
    dados.pecas = [];
    document.querySelectorAll('.linha-peca').forEach(linha => {
        const peca = {};
        linha.querySelectorAll('input, select').forEach(campo => {
            peca[campo.name || campo.className] = campo.value;
        });
        dados.pecas.push(peca);
    });

    // fotos
    dados.fotos = [];
    document.querySelectorAll('#previewFotos img').forEach(img => {
        dados.fotos.push(img.src);
    });

    // salvar local
    localStorage.setItem('checklistSalvo', JSON.stringify(dados));

    alert('Checklist salvo com sucesso.');
}

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active');
            });

            if (tabId === 'historico') carregarHistorico();
            if (tabId === 'relatorios') atualizarRelatorios();
            if (tabId === 'orcamento') atualizarResumoVeiculo(); // garante resumo atualizado ao abrir Pe√ßas
        }

        function salvarChecklist() {
            const placa = document.getElementById('placa').value;
            if (!placa) {
                alert("Por favor, preencha pelo menos a PLACA para salvar.");
                return;
            }

            const formData = {};
            const elements = document.getElementById('checklistForm').elements;

            for (let i = 0; i < elements.length; i++) {
                const item = elements[i];
                if (item.name) {
                    if (item.type === 'checkbox') {
                        if (item.checked) {
                            if (!formData[item.name]) formData[item.name] = [];
                            formData[item.name].push(item.value);
                        }
                    } else if (item.type !== 'button') {
                        formData[item.name] = item.value;
                    }
                }
            }

            const checklist = {
                id: Date.now(),
                data_criacao: new Date().toISOString(),
                ...formData
            };

            let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            checklists.push(checklist);
            localStorage.setItem('checklists', JSON.stringify(checklists));

            alert("‚úÖ Checklist salvo com sucesso no Hist√≥rico!");
            document.getElementById('checklistForm').reset();
            atualizarResumoVeiculo();
            switchTab('historico');
        }

        function carregarHistorico() {
            const listaDiv = document.getElementById('checklistsList');
            const emptyMsg = document.getElementById('emptyMessage');
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');

            listaDiv.innerHTML = '';

            if (checklists.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            checklists.slice().reverse().forEach(item => {
                const dataFormatada = new Date(item.data_criacao).toLocaleDateString('pt-BR');
                const horaFormatada = new Date(item.data_criacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                const card = document.createElement('div');
                card.className = 'checklist-item';
                card.innerHTML = `
                    <div class="checklist-info">
                        <h4>${(item.placa || '').toUpperCase()} - ${item.modelo || 'Modelo n√£o inf.'}</h4>
                        <p>üìÖ ${dataFormatada} √†s ${horaFormatada} | üë§ ${item.nome_cliente || 'Cliente n√£o inf.'}</p>
                    </div>
                    <div class="checklist-actions">
                        <button class="btn-small btn-secondary" onclick="carregarChecklist(${item.id})">‚úèÔ∏è Editar</button>
                        <button class="btn-small btn-danger" onclick="excluirChecklist(${item.id})">üóëÔ∏è</button>
                    </div>
                `;
                listaDiv.appendChild(card);
            });
        }

        function carregarChecklist(id) {
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            const item = checklists.find(c => c.id === id);

            if (item) {
                switchTab('novo-checklist');

                for (const key in item) {
                    const el = document.getElementsByName(key)[0];
                    if (el && el.type !== 'checkbox' && el.type !== 'file') {
                        el.value = item[key];
                    }
                }

                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

                if (item.equipamentos) item.equipamentos.forEach(val => marcarCheckbox('equipamentos', val));
                if (item.caracteristicas) item.caracteristicas.forEach(val => marcarCheckbox('caracteristicas', val));
                if (item.cambio) item.cambio.forEach(val => marcarCheckbox('cambio', val));
                if (item.tracao) item.tracao.forEach(val => marcarCheckbox('tracao', val));

                atualizarResumoVeiculo();
            }
        }

        function marcarCheckbox(name, value) {
            const els = document.getElementsByName(name);
            els.forEach(el => { if (el.value === value) el.checked = true; });
        }

        function excluirChecklist(id) {
            if (confirm("Tem certeza que deseja excluir este checklist?")) {
                let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
                checklists = checklists.filter(c => c.id !== id);
                localStorage.setItem('checklists', JSON.stringify(checklists));
                carregarHistorico();
            }
        }

        function filtrarChecklists() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            const listaDiv = document.getElementById('checklistsList');
            const emptyMsg = document.getElementById('emptyMessage');

            listaDiv.innerHTML = '';

            const filtrados = checklists.filter(item => {
                const texto = ((item.placa || '') + ' ' + (item.modelo || '') + ' ' + (item.nome_cliente || '')).toLowerCase();
                return texto.includes(termo);
            });

            if (!filtrados.length) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            filtrados.slice().reverse().forEach(item => {
                const dataFormatada = new Date(item.data_criacao).toLocaleDateString('pt-BR');
                const horaFormatada = new Date(item.data_criacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                const card = document.createElement('div');
                card.className = 'checklist-item';
                card.innerHTML = `
                    <div class="checklist-info">
                        <h4>${(item.placa || '').toUpperCase()} - ${item.modelo || 'Modelo n√£o inf.'}</h4>
                        <p>üìÖ ${dataFormatada} √†s ${horaFormatada} | üë§ ${item.nome_cliente || 'Cliente n√£o inf.'}</p>
                    </div>
                    <div class="checklist-actions">
                        <button class="btn-small btn-secondary" onclick="carregarChecklist(${item.id})">‚úèÔ∏è Editar</button>
                        <button class="btn-small btn-danger" onclick="excluirChecklist(${item.id})">üóëÔ∏è</button>
                    </div>
                `;
                listaDiv.appendChild(card);
            });
        }

        function ordenarChecklists() {
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            checklists.sort((a, b) => {
                const placaA = (a.placa || '').toUpperCase();
                const placaB = (b.placa || '').toUpperCase();
                if (placaA < placaB) return -1;
                if (placaA > placaB) return 1;
                return 0;
            });
            localStorage.setItem('checklists', JSON.stringify(checklists));
            carregarHistorico();
        }

        
function obterNumeroOS() {
    // Retorna formato: PLACA-DDMMAA
    const placa = (document.getElementById('placa')?.value || '').trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
    const agora = new Date();
    const dia = String(agora.getDate()).padStart(2, '0');
    const mes = String(agora.getMonth() + 1).padStart(2, '0');
    const ano = String(agora.getFullYear()).slice(-2); // Pega 26 de 2026

    if (!placa) return `OS-${dia}${mes}${ano}`; // Fallback se n√£o tiver placa

    return `${placa}-${dia}${mes}${ano}`;
}

function montarTabelaPDF(tbodyId, pdfBodyId) {
    const tbody = document.getElementById(tbodyId);
    const pdfBody = document.getElementById(pdfBodyId);
    pdfBody.innerHTML = '';
    let total = 0;
    if (tbody) {
        Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
            const tds = tr.querySelectorAll('td');
            if (tds.length < 2) return;
            const desc = (tds[0].textContent || '').trim();
            const valorNum = parseFloat((tds[1].textContent || '').replace('R$', '').replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            if (!desc) return;
            const row = document.createElement('tr');
            row.innerHTML = `<td style="border:1px solid #ddd; padding:7px;">${desc}</td><td style="border:1px solid #ddd; padding:7px; text-align:right;">R$ ${valorNum.toFixed(2)}</td>`;
            pdfBody.appendChild(row);
            total += valorNum;
        });
    }
    if (!pdfBody.children.length) {
        pdfBody.innerHTML = '<tr><td colspan="2" style="border:1px solid #ddd; padding:10px; text-align:center; color:#999;">Nenhum item</td></tr>';
    }
    return total;
}

function gerarPDF() {
    const placa = (document.getElementById('placa')?.value || '').trim();
    const cliente = (document.getElementById('nome_cliente')?.value || '').trim();
    if (!placa || !cliente) {
        alert('‚ö†Ô∏è Preencha PLACA e NOME do cliente antes de gerar o PDF.');
        return;
    }

    const os = obterNumeroOS(); // PLACA-DDMMAA

    const agora = new Date();
    const data = agora.toLocaleDateString('pt-BR');
    const hora = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

    const cfg = window.OFICINA_CONFIG || {};
    document.getElementById('pdfLogo').src = cfg.logo || 'logo.jpg';
    document.getElementById('pdfOficinaNome').textContent = (cfg.nome || 'OFICINA').toUpperCase();
    document.getElementById('pdfOficinaSubtitulo').textContent = cfg.subtitulo || 'Checklist de entrada e inspe√ß√£o veicular';
    document.getElementById('pdfOficinaTelefone').textContent = cfg.telefone || '(00) 00000-0000';
    document.getElementById('pdfOficinaEndereco').textContent = cfg.endereco || 'ENDERE√áO DA OFICINA';
    document.getElementById('pdfOficinaCNPJ').textContent = cfg.cnpj ? `CNPJ: ${cfg.cnpj}` : 'CNPJ: --';

    document.getElementById('pdfOSNumero').textContent = os;
    document.getElementById('pdfGeradoData').textContent = data;
    document.getElementById('pdfGeradoHora').textContent = hora;
    document.getElementById('pdfGeradoDataHora').textContent = `${data} ${hora}`;

    document.getElementById('pdfClienteNome').textContent = cliente.toUpperCase();
    document.getElementById('pdfClienteDoc').textContent = (document.getElementById('cpf_cnpj')?.value || '-');
    document.getElementById('pdfClienteTel').textContent = (document.getElementById('celular_cliente')?.value || '-');
    document.getElementById('pdfClienteEndereco').textContent = (document.getElementById('endereco_cliente')?.value || '-');

    document.getElementById('pdfVeiculoPlaca').textContent = placa.toUpperCase();
    document.getElementById('pdfVeiculoModelo').textContent = (document.getElementById('modelo')?.value || '-');
    document.getElementById('pdfVeiculoChassi').textContent = (document.getElementById('chassi')?.value || '-');
    document.getElementById('pdfVeiculoKM').textContent = (document.getElementById('km_entrada')?.value || '-');
    document.getElementById('pdfVeiculoEntrada').textContent = (document.getElementById('data')?.value || '-') + ' ' + (document.getElementById('hora')?.value || '-');
    const combSel = document.getElementById('combustivel');
    document.getElementById('pdfVeiculoCombustivel').textContent = combSel && combSel.selectedOptions?.[0] ? combSel.selectedOptions[0].textContent : (combSel?.value || '-');

    document.getElementById('pdfServicos').textContent = (document.getElementById('servicos')?.value || '-');

    const grid = document.getElementById('pdfInspecaoGrid');
    grid.innerHTML = '';
    [...document.querySelectorAll('input[name="equipamentos"]'), ...document.querySelectorAll('input[name="caracteristicas"]')].forEach(cb => {
        const label = document.querySelector(`label[for="${cb.id}"]`)?.textContent?.trim() || cb.value;
        const ok = !!cb.checked;
        const el = document.createElement('div');
        el.style.cssText = `background:${ok ? '#27ae60' : '#e74c3c'}; color:#fff; padding:9px 8px; border-radius:8px; font-size:10px; font-weight:800; text-align:center;`;
        el.textContent = `${ok ? '‚úÖ' : '‚ùå'} ${label}`;
        grid.appendChild(el);
    });

    const totalPecas = montarTabelaPDF('tabelaPecas', 'pdfPecasBody');
    const totalServicos = montarTabelaPDF('tabelaServicos', 'pdfServicosBody');
    document.getElementById('pdfTotalPecas').textContent = `R$ ${totalPecas.toFixed(2)}`;
    document.getElementById('pdfTotalServicos').textContent = `R$ ${totalServicos.toFixed(2)}`;
    document.getElementById('pdfTotalGeral').textContent = `R$ ${(totalPecas + totalServicos).toFixed(2)}`;

    const opt = {
        margin: [4, 4, 4, 4],
        filename: `Checklist-${os}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().set(opt).from(document.getElementById('containerPDF')).save();
}


        function limparFormulario() {
            if (confirm("Limpar todos os campos do formul√°rio?")) {
                document.getElementById('checklistForm').reset();
                atualizarResumoVeiculo();
            }
        }

        function exportarDados() {
            const db = JSON.parse(localStorage.getItem('checklists') || '[]');
            if (!db.length) {
                alert("N√£o h√° dados para exportar.");
                return;
            }
            const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checklists.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function limparTodosDados() {
            if (confirm("Deseja apagar TODO o hist√≥rico?")) {
                localStorage.removeItem('checklists');
                carregarHistorico();
                alert("Hist√≥rico limpo.");
            }
        }

        function atualizarRelatorios() {
            const db = JSON.parse(localStorage.getItem('checklists') || '[]');

            document.getElementById('totalChecklists').textContent = db.length;

            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const doMes = db.filter(item => {
                if (!item.data_criacao) return false;
                const dataItem = new Date(item.data_criacao);
                return dataItem.getMonth() === mesAtual && dataItem.getFullYear() === anoAtual;
            });
            document.getElementById('checklistsMes').textContent = doMes.length;

            const marcas = {};
            db.forEach(item => {
                const modeloTexto = item.modelo || 'N√£o Informado';
                const m = modeloTexto.split(' ')[0].toUpperCase();
                marcas[m] = (marcas[m] || 0) + 1;
            });

            const sortedMarcas = Object.entries(marcas).sort((a,b) => b[1] - a[1]).slice(0, 5);
            let htmlGrafico = '';
            sortedMarcas.forEach(([marca, qtd]) => {
                const pct = (qtd / db.length) * 100;
                htmlGrafico += `
                    <div style="margin-bottom: 10px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                            <strong>${marca}</strong>
                            <span>${qtd}</span>
                        </div>
                        <div style="background:#eee; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="background:var(--color-primary); width:${pct}%; height:100%;"></div>
                        </div>
                    </div>
                `;
            });

            if (!sortedMarcas.length) {
                htmlGrafico = '<p style="text-align:center; color:#999; font-size:12px;">Sem dados suficientes.</p>';
            }

            document.getElementById('graficoMarcas').innerHTML = htmlGrafico;
        }

// OR√áAMENTO - PE√áAS & SERVI√áOS - SEPARADOS
let itensOrcamento = [];

function adicionarItemManual() {
    const descricaoInput = document.getElementById('descricaoItem');
    const valorInput = document.getElementById('valorItem');
    
    // Captura qual tipo foi selecionado (radio button)
    const tipo = document.querySelector('input[name="tipoItem"]:checked').value; 

    const descricao = descricaoInput.value.trim();
    const valor = parseFloat(valorInput.value || '0');

    if (!descricao) {
        alert('Informe a descri√ß√£o do item.');
        descricaoInput.focus();
        return;
    }
    if (isNaN(valor) || valor < 0) {
        alert('Informe um valor v√°lido.');
        valorInput.focus();
        return;
    }

    const item = {
        id: Date.now(),
        descricao,
        valor,
        tipo // salva 'peca' ou 'servico'
    };

    itensOrcamento.push(item);
    renderizarTabela();
    
    descricaoInput.value = '';
    valorInput.value = '';
    descricaoInput.focus();
}

function removerItem(id) {
    itensOrcamento = itensOrcamento.filter(i => i.id !== id);
    renderizarTabela();
}

function renderizarTabela() {
    const tbodyPecas = document.getElementById('tabelaPecas');
    const tbodyServicos = document.getElementById('tabelaServicos');
    
    const elTotalPecas = document.getElementById('totalPecas');
    const elTotalServicos = document.getElementById('totalServicos');
    const elTotalGeral = document.getElementById('totalGeralFinal');

    // Limpa tabelas
    if(tbodyPecas) tbodyPecas.innerHTML = '';
    if(tbodyServicos) tbodyServicos.innerHTML = '';

    let somaPecas = 0;
    let somaServicos = 0;

    itensOrcamento.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="border:1px solid #ddd; padding:6px;">${item.descricao}</td>
          <td style="border:1px solid #ddd; padding:6px; text-align:right;">R$ ${item.valor.toFixed(2)}</td>
          <td style="border:1px solid #ddd; padding:6px; text-align:center;">
            <button class="btn-small btn-danger" onclick="removerItem(${item.id})">üóëÔ∏è</button>
          </td>
        `;

        if (item.tipo === 'servico') {
            somaServicos += item.valor;
            if(tbodyServicos) tbodyServicos.appendChild(tr);
        } else {
            // Default √© pe√ßa
            somaPecas += item.valor;
            if(tbodyPecas) tbodyPecas.appendChild(tr);
        }
    });

    // Atualiza totais na tela
    if(elTotalPecas) elTotalPecas.textContent = 'R$ ' + somaPecas.toFixed(2);
    if(elTotalServicos) elTotalServicos.textContent = 'R$ ' + somaServicos.toFixed(2);
    
    const somaTotal = somaPecas + somaServicos;
    if(elTotalGeral) elTotalGeral.textContent = 'R$ ' + somaTotal.toFixed(2);
}

        // ENTER nos campos de Pe√ßas & Servi√ßos adiciona linha
        document.addEventListener('DOMContentLoaded', () => {
            carregarHistorico();
            atualizarResumoVeiculo();

            const descricaoItem = document.getElementById('descricaoItem');
            const valorItem = document.getElementById('valorItem');

            descricaoItem.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    adicionarItemManual();
                }
            });

            valorItem.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    adicionarItemManual();
                }
            });

            const camposResumo = ['placa','modelo','chassi','km_entrada','data','hora','combustivel','complexidade'];
            camposResumo.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const tipo = (el.tagName === 'SELECT' || el.type === 'date' || el.type === 'time') ? 'change' : 'input';
                el.addEventListener(tipo, atualizarResumoVeiculo);
            });
        });

        function atualizarResumoVeiculo() {
            const placa = document.getElementById('placa').value || '-';
            const modelo = document.getElementById('modelo').value || '-';
            const chassi = document.getElementById('chassi').value || '-';
            const kmEntrada = document.getElementById('km_entrada').value || '-';
            const data = document.getElementById('data').value || '-';
            const hora = document.getElementById('hora').value || '-';
            const combustivel = document.getElementById('combustivel').value || '-';
            const complexidade = document.getElementById('complexidade').value || '-';

            document.getElementById('resumoPlaca').textContent = placa;
            document.getElementById('resumoModelo').textContent = modelo;
            document.getElementById('resumoChassi').textContent = chassi;
            document.getElementById('resumoKmEntrada').textContent = kmEntrada;
            document.getElementById('resumoData').textContent = data;
            document.getElementById('resumoHora').textContent = hora;
            document.getElementById('resumoCombustivel').textContent = combustivel;

            document.getElementById('resumoPlaca2').textContent = placa;
            document.getElementById('resumoModelo2').textContent = modelo;
            document.getElementById('resumoChassi2').textContent = chassi;
            document.getElementById('resumoKmEntrada2').textContent = kmEntrada;
            document.getElementById('resumoComplexidade').textContent = complexidade || '-';
// FOTOS
const resumoPlaca3 = document.getElementById('resumoPlaca3');
const resumoModelo3 = document.getElementById('resumoModelo3');
const resumoChassi3 = document.getElementById('resumoChassi3');
const resumoKmFotos = document.getElementById('resumoKmFotos');
if (resumoPlaca3) resumoPlaca3.textContent = placa;
if (resumoModelo3) resumoModelo3.textContent = modelo;
if (resumoChassi3) resumoChassi3.textContent = chassi;
if (resumoKmFotos) resumoKmFotos.textContent = kmEntrada;

        }
// ========================================
// FOTOS - 100% FUNCIONAL
// ========================================
let streamCamera = null;
let fotosVeiculo = JSON.parse(localStorage.getItem('fotosVeiculo') || '[]');

function iniciarCamera() {
    const video = document.getElementById('cameraPreview');
    const btnTirar = document.getElementById('btnTirarFoto');
    const container = document.querySelector('.camera-container');
    
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    }).then(stream => {
        streamCamera = stream;
        video.srcObject = stream;
        container.style.display = 'block';
        btnTirar.style.display = 'inline-block';
        video.play();
    }).catch(err => {
        alert('Erro c√¢mera: ' + err.message + '\nUse "Galeria"');
    });
}

function tirarFoto() {
    const video = document.getElementById('cameraPreview');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    const foto = {
        id: Date.now(),
        dataURL: canvas.toDataURL('image/jpeg', 0.8),
        data: new Date().toLocaleString('pt-BR')
    };
    
    fotosVeiculo.unshift(foto);
    if (fotosVeiculo.length > 15) fotosVeiculo = fotosVeiculo.slice(0, 15);
    localStorage.setItem('fotosVeiculo', JSON.stringify(fotosVeiculo));
    renderizarGaleria();
    pararCamera();
}

function pararCamera() {
    if (streamCamera) {
        streamCamera.getTracks().forEach(track => track.stop());
        streamCamera = null;
    }
    document.querySelector('.camera-container').style.display = 'none';
    document.getElementById('btnTirarFoto').style.display = 'none';
}

function adicionarFotos(event) {
    const files = Array.from(event.target.files);
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            fotosVeiculo.unshift({
                id: Date.now() + Math.random(),
                dataURL: e.target.result,
                data: new Date().toLocaleString('pt-BR')
            });
            if (fotosVeiculo.length > 15) fotosVeiculo = fotosVeiculo.slice(0, 15);
            localStorage.setItem('fotosVeiculo', JSON.stringify(fotosVeiculo));
            renderizarGaleria();
        };
        reader.readAsDataURL(file);
    });
    event.target.value = '';
}

function renderizarGaleria() {
    const galeria = document.getElementById('galeriaFotos');
    if (!galeria) return;
    galeria.innerHTML = '';
    
    if (fotosVeiculo.length === 0) {
        galeria.innerHTML = '<p style="text-align:center;color:#999;padding:40px">üì≠ Nenhuma foto</p>';
        return;
    }
    
    fotosVeiculo.slice(0, 15).forEach((foto, index) => {
        const div = document.createElement('div');
        div.className = 'foto-item';
        div.innerHTML = `
            <img src="${foto.dataURL}" alt="Foto ${index + 1}" loading="lazy">
            <div class="foto-overlay"><span style="color:white;font-size:11px">${foto.data}</span></div>
            <div class="foto-actions">
                <button class="btn-foto btn-warning foto-zoom" data-url="${foto.dataURL}">üîç</button>
                <button class="btn-foto btn-danger foto-delete" data-id="${foto.id}">üóëÔ∏è</button>
            </div>
        `;
        galeria.appendChild(div);
    });
    
    // EVENTOS DELEGADOS
    galeria.querySelectorAll('.foto-zoom').forEach(btn => {
        btn.addEventListener('click', () => abrirFotoGrande(btn.dataset.url));
    });
    galeria.querySelectorAll('.foto-delete').forEach(btn => {
        btn.addEventListener('click', () => removerFoto(parseInt(btn.dataset.id)));
    });
}

function removerFoto(id) {
    fotosVeiculo = fotosVeiculo.filter(f => f.id !== id);
    localStorage.setItem('fotosVeiculo', JSON.stringify(fotosVeiculo));
    renderizarGaleria();
    mostrarAlerta('success', '‚úÖ Foto removida!');
}

function limparFotos() {
    if (confirm('üóëÔ∏è Limpar TODAS as fotos?')) {
        fotosVeiculo = [];
        localStorage.removeItem('fotosVeiculo');
        renderizarGaleria();
        mostrarAlerta('success', '‚úÖ Fotos limpas!');
    }
}

function abrirFotoGrande(dataURL) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position:fixed; top:0; left:0; width:100vw; height:100vh; 
        background:rgba(0,0,0,0.95); z-index:9999; display:flex; 
        align-items:center; justify-content:center; padding:20px;
    `;
    modal.innerHTML = `
        <img src="${dataURL}" style="max-width:95%; max-height:95%; border-radius:8px; box-shadow:0 0 50px rgba(255,255,255,0.3);">
        <button onclick="this.parentElement.remove()" style="
            position:absolute; top:20px; right:20px; background:#e41616; 
            color:white; border:none; border-radius:50%; width:50px; 
            height:50px; font-size:20px; cursor:pointer;
        ">‚úï</button>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function gerarPDFFotos() {
    if (!fotosVeiculo || fotosVeiculo.length === 0) {
        alert('üì≠ Sem fotos para gerar PDF');
        return;
    }

    const placa  = document.getElementById('placa')?.value  || 'SEM_PLACA';
    const modelo = document.getElementById('modelo')?.value || 'SEM_MODELO';
    const chassi = document.getElementById('chassi')?.value || 'SEM_CHASSI';

    const MAXFOTOS = 16;
    const fotosUsar = fotosVeiculo.slice(0, MAXFOTOS);

    let html = '';

    // Cada grupo de 4 fotos = 1 p√°gina (2x2)
    for (let i = 0; i < fotosUsar.length; i += 4) {
        const isLastGroup = i + 4 >= fotosUsar.length;

        html += `
            <div style="
                width: 100%;
                min-height: 100vh;
                box-sizing: border-box;
                padding: 20px;
                font-family: Arial, sans-serif;
                ${isLastGroup ? '' : 'page-break-after: always;'}
            ">
                <!-- CABE√áALHO COM DADOS DO CARRO -->
                <div style="
                    background: #f5f5f5;
                    border: 2px solid #e41616;
                    border-radius: 6px;
                    padding: 10px 15px;
                    margin-bottom: 15px;
                    font-size: 11px;
                    line-height: 1.5;
                ">
                    <div style="font-weight: bold; color: #e41616; font-size: 12px; margin-bottom: 5px;">- INSPE√á√ÉO DE FOTOS</div>
                    <div><strong>Placa:</strong> ${placa}</div>
                    <div><strong>Modelo:</strong> ${modelo}</div>
                    <div><strong>Chassi:</strong> ${chassi}</div>
                </div>

                <!-- GRADE DE 4 FOTOS 2x2 -->
                <div style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                ">
        `;

        for (let j = 0; j < 4 && (i + j) < fotosUsar.length; j++) {
            const foto = fotosUsar[i + j];
            const num = i + j + 1;

            html += `
                <div style="text-align: center;">
                    <img src="${foto.dataURL}"
                         style="
                             width: 100%;
                             max-width: 260px;
                             max-height: 260px;
                             height: auto;
                             border-radius: 6px;
                             border: 1px solid #e41616;
                         ">
                    <div style="
                        font-size: 9px;
                        margin-top: 5px;
                        color: #555;
                    ">
                        Foto ${num} - ${foto.data || ''}
                    </div>
                </div>
            `;
        }

        html += `
                </div>
            </div>
        `;
    }

    html2pdf().set({
        filename: `Fotos-${placa}.pdf`,
        margin: 0,
        image: { type: 'jpeg', quality: 0.9 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            scrollY: 0
        },
        jsPDF: {
            format: 'a4',
            orientation: 'portrait',
            unit: 'pt'
        }
    }).from(html).save();

    mostrarAlerta('success', `‚úÖ PDF gerado com ${fotosUsar.length} fotos (m√°ximo 16)`);
}

// INICIALIZAR FOTOS
document.addEventListener('DOMContentLoaded', () => {
    renderizarGaleria();
});

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,CmNvbnN0IENBQ0hFX05BTUUgPSAnY2hlY2tsaXN0LXYzLWNhY2hlJzsKY29uc3QgVVJMU19UT19DQUNIRSA9IFsKICAnLycsCiAgJy9pbmRleC5odG1sJwpdOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgKGV2ZW50KSA9PiB7CiAgY29uc3QgY2FjaGVPcGVuID0gY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkudGhlbigY2xpZW50KSA9PiB7CiAgICByZXR1cm4gY2xpZW50LmFkZEFsbChVUkxzX1RPX0NBQ0hFKTsKICB9KTsKICBldmVudC53YWl0VW50aWwoKGNhY2hlT3Blbik7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIChldmVudCkgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgIGlmIChyZXNwb25zZSkgewogICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAgfQogICAgICByZXR1cm4gZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgICB9KQogICk7Cn0pOwo=');
        }
    </script>
<button id="btnSalvarChecklist" onclick="salvarChecklist()">
    üíæ Salvar Checklist
</button>
<script src="config.js"></script>
<script src="app.js"></script>
</body>
</html>
