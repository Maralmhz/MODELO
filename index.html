<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Checklist de Oficina - App Offline com PDF">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="wizard.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
   <title id="titulo-pagina">Checklist de Entrada ‚Äì Oficina</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
       <div class="header">
    <div class="logo-container">
        <img id="logo-oficina" src="logo.png" alt="Logo da Oficina">
    </div>
    <div class="header-content">
        <!-- ‚úÖ NEUTRO - PREENCHER NO CONFIG.JS -->
        <h1 id="nome-oficina">OFICINA</h1>
        <p id="subtitulo-oficina">Checklist de entrada e inspe√ß√£o veicular</p>
        <div class="contato-info">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" class="whatsapp-icon">
            <span id="telefone-oficina">(00) 00000-0000</span>
        </div>
        <div class="endereco-oficina" id="endereco-oficina">
            ENDERE√áO DA OFICINA
        </div>

                <div class="status-sync">
                    <div class="sync-dot" id="syncStatus"></div>
                    <span id="syncText">Online</span>
                </div>
            </div>
            <div class="header-badge">v3.0 PRO</div>
        </div>
<div class="tabs">
    <button class="tab-button active" onclick="switchTab('novo-checklist')">‚ûï Novo Checklist</button>
    <button class="tab-button" onclick="switchTab('orcamento')">üí∞ Pe√ßas & Servi√ßos</button>
    <button class="tab-button" onclick="switchTab('fotos')">üì∏ Fotos</button>
    <button class="tab-button" onclick="switchTab('historico')">üìã Hist√≥rico</button>
    <button class="tab-button" onclick="switchTab('relatorios')">üìä Relat√≥rios</button>
</div>


        <!-- ABA PRINCIPAL - CHECKLIST -->
        <div id="novo-checklist" class="tab-content active">
            <div class="content">
                <div id="successMessage" class="alert alert-success"></div>
                <div id="errorMessage" class="alert alert-error"></div>
                <div id="infoMessage" class="alert alert-info"></div>

                <form id="checklistForm">
                    <div class="section-title">üìã INFORMA√á√ïES DO VE√çCULO</div>

                    <!-- RESUMO FIXO DO VE√çCULO (VISUAL) -->
                    <div class="veiculo-resumo" id="resumoVeiculoPrincipal">
                        <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca">-</strong></div>
                        <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo">-</strong></div>
                        <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi">-</strong></div>
                        <div class="veiculo-resumo-pill">KM Entrada: <strong id="resumoKmEntrada">-</strong></div>
                        <div class="veiculo-resumo-pill">Data Entrada: <strong id="resumoData">-</strong></div>
                        <div class="veiculo-resumo-pill">Hora Entrada: <strong id="resumoHora">-</strong></div>
                        <div class="veiculo-resumo-pill">Combust√≠vel: <strong id="resumoCombustivel">-</strong></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="placa">Placa *</label>
                            <input type="text" id="placa" name="placa" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="chassi">Chassi</label>
                            <input type="text" id="chassi" name="chassi" placeholder="17 d√≠gitos" maxlength="17">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modelo">Modelo</label>
                            <input type="text" id="modelo" name="modelo" placeholder="Ex: Fiat Uno">
                        </div>
                        <div class="form-group">
                            <label for="km_entrada">KM Entrada</label>
                            <input type="text" id="km_entrada" name="km_entrada" placeholder="150.000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="data">Data Entrada</label>
                            <input type="date" id="data" name="data">
                        </div>
                        <div class="form-group">
                            <label for="hora">Hora Entrada</label>
                            <input type="time" id="hora" name="hora">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="combustivel">N√≠vel Combust√≠vel</label>
                            <select id="combustivel" name="combustivel">
                                <option value="">Selecione...</option>
                                <option value="cheio">Cheio</option>
                                <option value="meio">Meio</option>
                                <option value="1/4">1/4</option>
                                <option value="vazio">Vazio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="km_saida">KM Sa√≠da</label>
                            <input type="text" id="km_saida" name="km_saida" placeholder="150.500">
                        </div>
                    </div>

                    <div class="section-title">üöó CARACTER√çSTICAS DO VE√çCULO</div>

                    <div class="equip-section">
                        <div class="equip-section-title">üîß ACESS√ìRIOS OBRIGAT√ìRIOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="estepe" name="equipamentos" value="ESTEPE"><label for="estepe">ESTEPE</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="macaco" name="equipamentos" value="MACACO"><label for="macaco">MACACO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="chave_roda" name="equipamentos" value="CHAVE DE RODA"><label for="chave_roda">CHAVE DE RODA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="triangulo" name="equipamentos" value="TRI√ÇNGULO"><label for="triangulo">TRI√ÇNGULO</label></div>
                        </div>
                    </div>

<div class="equip-section">
    <div class="equip-section-title">‚õΩ TIPO COMBUST√çVEL</div>
    <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="gasolina" name="equipamentos" value="GASOLINA"><label for="gasolina">GASOLINA</label></div>
        <div class="checkbox-item"><input type="checkbox" id="etanol" name="equipamentos" value="ETANOL"><label for="etanol">ETANOL</label></div>
        <div class="checkbox-item"><input type="checkbox" id="gnv" name="equipamentos" value="GNV"><label for="gnv">GNV</label></div>
        <div class="checkbox-item"><input type="checkbox" id="diesel" name="equipamentos" value="DIESEL"><label for="diesel">DIESEL</label></div>
    </div>
</div>



                    <div class="equip-section">
                        <div class="equip-section-title">üîä ELETR√îNICOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="radio" name="equipamentos" value="R√ÅDIO / MULTIM√çDIA"><label for="radio">R√ÅDIO / MULTIM√çDIA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="alarme_corta" name="equipamentos" value="ALARME / CORTA CORRENTE"><label for="alarme_corta">ALARME / CORTA CORRENTE</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="antena" name="equipamentos" value="ANTENA"><label for="antena">ANTENA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="acendedor" name="equipamentos" value="ACENDEDOR/TOMADA 12V"><label for="acendedor">ACENDEDOR/TOMADA 12V</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
                        <div class="equip-section-title">‚ö° EL√âTRICOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="vidro_eletrico" name="equipamentos" value="VIDRO EL√âTRICO"><label for="vidro_eletrico">VIDRO EL√âTRICO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="trava_eletrica" name="equipamentos" value="TRAVA EL√âTRICA"><label for="trava_eletrica">TRAVA EL√âTRICA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="buzina" name="equipamentos" value="BUZINA"><label for="buzina">BUZINA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="bateria" name="equipamentos" value="BATERIA"><label for="bateria">BATERIA</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
                        <div class="equip-section-title">üõû RODAS & P√ÅRA-BRISAS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="calotas" name="equipamentos" value="CALOTAS"><label for="calotas">CALOTAS</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rodas_liga" name="equipamentos" value="RODAS DE LIGA"><label for="rodas_liga">RODAS DE LIGA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="roda_ferro" name="equipamentos" value="RODA DE FERRO"><label for="roda_ferro">RODA DE FERRO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="para_brisa" name="equipamentos" value="PARABRISA TRINCADO"><label for="para_brisa">P√ÅRA BRISA TRICADO</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
    <div class="equip-section-title">üì¶ DEMAIS ACESS√ìRIOS</div>
    <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="extintor" name="equipamentos" value="EXTINTOR"><label for="extintor">EXTINTOR</label></div>
        <div class="checkbox-item"><input type="checkbox" id="protetor_carter" name="equipamentos" value="PROTETOR DE CARTER"><label for="protetor_carter">PROTETOR DE CARTER</label></div>
        <div class="checkbox-item"><input type="checkbox" id="chave_secreta" name="equipamentos" value="CHAVE SEGREDO (RODA)"><label for="chave_secreta">CHAVE SEGREDO (RODA)</label></div>
        <div class="checkbox-item"><input type="checkbox" id="tapetes" name="equipamentos" value="TAPETES"><label for="tapetes">TAPETES</label></div>
    </div>
</div>


                    <div class="equip-section">
                        <div class="equip-section-title">‚≠ê EQUIPAMENTOS PRINCIPAIS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="ar" name="caracteristicas" value="AR"><label for="ar">AR</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="abs" name="caracteristicas" value="ABS"><label for="abs">ABS</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="airbag" name="caracteristicas" value="Air Bag"><label for="airbag">Air Bag</label></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>C√¢mbio</label>
                            <div class="checkbox-group" style="margin-top: 5px;">
                                <div class="checkbox-item"><input type="checkbox" id="cambio_auto" name="cambio" value="Autom√°tico"><label for="cambio_auto">Autom√°tico</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="cambio_manual" name="cambio" value="Manual"><label for="cambio_manual">Manual</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tra√ß√£o</label>
                            <div class="checkbox-group" style="margin-top: 5px;">
                                <div class="checkbox-item"><input type="checkbox" id="tracao_4x2" name="tracao" value="4x2"><label for="tracao_4x2">4x2</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="tracao_4x4" name="tracao" value="4x4"><label for="tracao_4x4">4x4</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">üë§ DADOS DO CLIENTE</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_cliente">Nome *</label>
                            <input type="text" id="nome_cliente" name="nome_cliente" placeholder="Nome completo do cliente">
                        </div>
                        <div class="form-group">
                            <label for="cpf_cnpj">CPF / CNPJ</label>
                            <input type="text" id="cpf_cnpj" name="cpf_cnpj" placeholder="000.000.000-00" maxlength="18">
                        </div>
                    </div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="endereco_cliente">Endere√ßo Completo</label>
                            <textarea id="endereco_cliente" name="endereco_cliente" placeholder="Rua, n√∫mero, bairro, cidade - UF, CEP" style="height: 60px; min-height: 60px;"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="celular_cliente">Celular / WhatsApp *</label>
                            <input type="tel" id="celular_cliente" name="celular_cliente" placeholder="(31) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label for="telefone2">Telefone 2 (opcional)</label>
                            <input type="tel" id="telefone2" name="telefone2" placeholder="(31) 9999-9999">
                        </div>
                    </div>

                    <div class="section-title">üîß SERVI√áOS/SOLICITADOS</div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="servicos">Descreva os servi√ßos solicitados:</label>
                            <textarea id="servicos" name="servicos" placeholder="Ex: Troca de √≥leo e filtro, alinhamento e balanceamento..."></textarea>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" class="btn-success" onclick="gerarPDF()">üìÑ Gerar PDF</button>
                        <button type="button" class="btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ABA HIST√ìRICO -->
        <div id="historico" class="tab-content">
            <div class="content">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por placa, modelo ou cliente..." onkeyup="filtrarChecklists()">
                    <button class="btn-secondary btn-small" onclick="ordenarChecklists()">üìä Ordenar</button>
                </div>

                <div id="checklistsList"></div>
                <div id="emptyMessage" style="text-align: center; padding: 40px; color: #999;">
                    <p style="font-size: 40px; margin-bottom: 10px;">üì≠</p>
                    <p>Nenhum checklist salvo ainda. Crie um novo para come√ßar!</p>
                </div>
            </div>
        </div>

        <!-- ABA RELAT√ìRIOS -->
        <div id="relatorios" class="tab-content">
            <div class="content">
                <div class="section-title">üìä ESTAT√çSTICAS GERAIS</div>
                <div class="stats-box">
                    <div class="stat-card">
                        <div class="stat-number" id="totalChecklists">0</div>
                        <div class="stat-label">Checklists Salvos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="checklistsMes">0</div>
                        <div class="stat-label">Checklists M√™s Atual</div>
                    </div>
                </div>

                <div class="section-title">üöó MARCAS MAIS ATENDIDAS</div>
                <div id="graficoMarcas" style="margin-top: 20px;"></div>

                <div class="action-buttons">
<button id="btnSalvarChecklist" class="btn-success" onclick="salvarChecklist()">Salvar Checklist</button>
                    <button class="btn-primary" onclick="exportarDados()">üíæ Exportar Todos (JSON)</button>
                    <button class="btn-danger" onclick="limparTodosDados()">üóëÔ∏è Limpar Hist√≥rico</button>
                </div>
            </div>
        </div>

        <!-- ABA OR√áAMENTO ‚Äì PLANILHA DE PE√áAS & SERVI√áOS -->
        <div id="orcamento" class="tab-content">
            <div class="content">
                <div class="section-title">üí∞ PE√áAS & SERVI√áOS</div>

                <!-- RESUMO FIXO DO VE√çCULO TAMB√âM NA ABA DE PE√áAS -->
                <div class="veiculo-resumo" id="resumoVeiculoOrcamento">
                    <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca2">-</strong></div>
                    <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo2">-</strong></div>
                    <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi2">-</strong></div>
                    <div class="veiculo-resumo-pill">KM Entrada: <strong id="resumoKmEntrada2">-</strong></div>
                    <div class="veiculo-resumo-pill">Complexidade: <strong id="resumoComplexidade">-</strong></div>
                </div>

                <!-- COMPLEXIDADE -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="complexidade">Complexidade do evento</label>
                        <select id="complexidade" name="complexidade">
                            <option value="">Selecione...</option>
                            <option value="pequena monta">Pequena monta</option>
                            <option value="meia monta">Meia monta</option>
                            <option value="grande monta">Grande monta</option>
                        </select>
                    </div>
                </div>

              <!-- DENTRO DA DIV #orcamento -->

<!-- 1. Adicione a sele√ß√£o de Tipo (Pe√ßa ou Servi√ßo) no formul√°rio -->
<div class="form-row">
    <div class="form-group">
        <label>Tipo do Item:</label>
        <div class="checkbox-group" style="margin-top: 5px;">
            <div class="checkbox-item">
                <input type="radio" id="tipoPeca" name="tipoItem" value="peca" checked>
                <label for="tipoPeca">Pe√ßa</label>
            </div>
            <div class="checkbox-item">
                <input type="radio" id="tipoServico" name="tipoItem" value="servico">
                <label for="tipoServico">Servi√ßo</label>
            </div>
        </div>
    </div>
</div>

<div class="form-row two">
    <div class="form-group">
        <label for="descricaoItem">Descri√ß√£o</label>
        <input type="text" id="descricaoItem" placeholder="Ex: Pastilha de Freio / M√£o de obra">
    </div>
    <div class="form-group">
        <label for="valorItem">Valor (R$)</label>
        <input type="number" id="valorItem" step="0.01" min="0" placeholder="0,00">
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <button type="button" class="btn-primary" onclick="adicionarItemManual()">‚ûï Adicionar</button>
    </div>
</div>

<!-- 2. Substitua a tabela antiga por DUAS tabelas novas -->
<div style="margin-top:20px;">
    
    <!-- SE√á√ÉO DE PE√áAS -->
    <h4 style="border-bottom: 2px solid #e41616; padding-bottom: 5px; color: #333;">üî© Pe√ßas</h4>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom: 10px;">
        <thead>
            <tr style="background:#f7f7f7;">
                <th style="border:1px solid #ddd; padding:6px; text-align:left;">Descri√ß√£o</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width: 100px;">Valor</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width: 50px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaPecas"></tbody>
        <tfoot>
            <tr>
                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">Total Pe√ßas:</td>
                <td id="totalPecas" style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold; color: #e41616;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- SE√á√ÉO DE SERVI√áOS -->
    <h4 style="border-bottom: 2px solid #0056b3; padding-bottom: 5px; color: #333; margin-top: 25px;">üîß Servi√ßos</h4>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom: 10px;">
        <thead>
            <tr style="background:#f7f7f7;">
                <th style="border:1px solid #ddd; padding:6px; text-align:left;">Descri√ß√£o</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width: 100px;">Valor</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width: 50px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaServicos"></tbody>
        <tfoot>
            <tr>
                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">Total Servi√ßos:</td>
                <td id="totalServicos" style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold; color: #0056b3;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- TOTAL GERAL (SOMA DOS DOIS) -->
    <div style="background: #eee; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: right;">
        <span style="font-size: 14px; font-weight: bold; color: #555;">TOTAL GERAL (Pe√ßas + Servi√ßos):</span>
        <div id="totalGeralFinal" style="font-size: 24px; font-weight: bold; color: #28a745;">R$ 0,00</div>
    </div>

</div>
                <div class="action-buttons">
    <button type="button" class="btn-success" onclick="gerarPDF()">üìÑ Gerar PDF</button>
</div>
            </div>
        </div>
<!-- ABA FOTOS ‚úÖ PERFEITA -->
<div id="fotos" class="tab-content">
    <div class="content">
        <div class="section-title">üì∏ FOTOS DO VE√çCULO</div>
        
        <!-- RESUMO VE√çCULO -->
        <div class="veiculo-resumo" id="resumoVeiculoFotos">
            <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca3">-</strong></div>
            <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo3">-</strong></div>
            <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi3">-</strong></div>
            <div class="veiculo-resumo-pill">KM: <strong id="resumoKmFotos">-</strong></div>
        </div>

        <!-- BOT√ïES -->
        <div class="form-row">
            <div class="form-group">
                <button type="button" class="btn-primary" onclick="iniciarCamera()">üì∑ Tirar Foto</button>
            </div>
            <div class="form-group">
                <input type="file" id="uploadFotos" multiple accept="image/*" onchange="adicionarFotos(event)">
                <label for="uploadFotos" class="btn-secondary" style="cursor:pointer; padding:12px 24px; display:block; text-align:center;">üìÅ Galeria</label>
            </div>
        </div>

        <!-- C√ÇMERA -->
        <div class="camera-container" style="display:none;">
            <video id="cameraPreview" autoplay playsinline style="width:100%; max-width:400px; height:300px; border-radius:12px; border:3px solid #e41616; background:#000;"></video>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                <button class="btn-success btn-small" onclick="tirarFoto()" id="btnTirarFoto" style="display:none;">üì∏ Capturar</button>
                <button class="btn-secondary btn-small" onclick="pararCamera()">‚ùå Cancelar</button>
            </div>
        </div>

        <!-- GALERIA -->
        <div class="section-title">Galeria de Fotos (M√°x 15)</div>
        <div id="galeriaFotos" class="fotos-grid"></div>

        <div class="action-buttons">
            <button type="button" class="btn-success" onclick="gerarPDFFotos()">üìÑ PDF Fotos</button>
            <button type="button" class="btn-danger" onclick="limparFotos()">üóëÔ∏è Limpar Fotos</button>
        </div>
    </div>
</div>

    </div>
<button id="btnSalvarChecklist" onclick="salvarChecklist()">
    üíæ Salvar Checklist
</button>
<script src="config.js"></script>
<script src="app.js"></script>
<script src="wizard.js"></script>
<script src="os_system.js"></script>
<script src="pdf_generator.js"></script>
<script src="setup_buttons.js"></script>
<script>
// ==========================================
// 1. VARI√ÅVEIS GLOBAIS
// ==========================================
let itensOrcamento = []; 

// ==========================================
// 2. NAVEGA√á√ÉO ENTRE ABAS (FIXA)
// ==========================================
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

    const target = document.getElementById(tabId);
    if (target) {
        target.classList.add('active');

        // Ativa bot√µes
        document.querySelectorAll('.tab-button').forEach(btn => {
            const oc = btn.getAttribute('onclick');
            if (oc && oc.includes(tabId)) btn.classList.add('active');
        });

        if (tabId === 'historico') carregarHistorico();
        if (tabId === 'relatorios') atualizarRelatorios();
        if (tabId === 'orcamento') {
            atualizarResumoVeiculo();
            renderizarTabela();
        }
    }
}

// ==========================================
// 3. PE√áAS E SERVI√áOS
// ==========================================
function adicionarItemManual() {
    const desc = document.getElementById('descricaoItem').value;
    const val = document.getElementById('valorItem').value;
    const tipo = document.querySelector('input[name="tipoItem"]:checked')?.value || 'peca';

    if (!desc || !val) { alert("Preencha descri√ß√£o e valor!"); return; }

    itensOrcamento.push({
        id: Date.now(),
        descricao: desc.toUpperCase(),
        valor: parseFloat(val),
        tipo: tipo
    });

    renderizarTabela();
    document.getElementById('descricaoItem').value = '';
    document.getElementById('valorItem').value = '';
    document.getElementById('descricaoItem').focus();
}

function renderizarTabela() {
    const tbodyPecas = document.getElementById('tabelaPecas');
    const tbodyServicos = document.getElementById('tabelaServicos');

    if (!tbodyPecas || !tbodyServicos) return;

    tbodyPecas.innerHTML = '';
    tbodyServicos.innerHTML = '';

    let totalP = 0;
    let totalS = 0;

    itensOrcamento.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #eee';
        tr.innerHTML = `
            <td style="padding:8px;">${item.descricao}</td>
            <td style="padding:8px; text-align:right;">R$ ${item.valor.toFixed(2)}</td>
            <td style="padding:8px; text-align:center;">
                <button onclick="removerItem(${item.id})" style="background:none; border:none; cursor:pointer;">‚ùå</button>
            </td>
        `;

        if (item.tipo === 'peca') { tbodyPecas.appendChild(tr); totalP += item.valor; } 
        else { tbodyServicos.appendChild(tr); totalS += item.valor; }
    });

    if(document.getElementById('totalPecas')) document.getElementById('totalPecas').innerText = `R$ ${totalP.toFixed(2)}`;
    if(document.getElementById('totalServicos')) document.getElementById('totalServicos').innerText = `R$ ${totalS.toFixed(2)}`;
    if(document.getElementById('totalGeralFinal')) document.getElementById('totalGeralFinal').innerText = `R$ ${(totalP + totalS).toFixed(2)}`;
}

function removerItem(id) {
    itensOrcamento = itensOrcamento.filter(i => i.id !== id);
    renderizarTabela();
}

// ==========================================
// 4. SALVAR E CARREGAR
// ==========================================
function salvarChecklist() {
    const placa = document.getElementById('placa').value;
    if (!placa) { alert("Preencha a PLACA para salvar."); return; }

    const formData = {};
    document.querySelectorAll('input, select, textarea').forEach(el => {
        if (!el.name) return;
        if (el.type === 'checkbox') {
            if (el.checked) {
                if (!formData[el.name]) formData[el.name] = [];
                formData[el.name].push(el.value);
            }
        } else if (el.type !== 'radio' || el.checked) {
            formData[el.name] = el.value;
        }
    });

    const checklist = {
        id: Date.now(),
        data_criacao: new Date().toISOString(),
        itensOrcamento: itensOrcamento,
        ...formData
    };

    let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
    checklists.push(checklist);
    localStorage.setItem('checklists', JSON.stringify(checklists));

    alert("‚úÖ Salvo com sucesso!");
    limparFormulario();
    switchTab('historico');
}

function carregarChecklist(id) {
    const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
    const item = checklists.find(c => c.id === id);

    if (item) {
        switchTab('novo-checklist');
        for (const key in item) {
            const el = document.getElementsByName(key)[0];
            if (el && el.type !== 'checkbox' && el.type !== 'file') el.value = item[key];
        }
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        ['equipamentos', 'caracteristicas', 'cambio', 'tracao'].forEach(gp => {
            if (item[gp]) item[gp].forEach(val => {
                const cb = document.querySelector(`input[name="${gp}"][value="${val}"]`);
                if (cb) cb.checked = true;
            });
        });
        itensOrcamento = item.itensOrcamento || []; 
        renderizarTabela(); 
        atualizarResumoVeiculo();
    }
}

function limparFormulario() {
    document.getElementById('checklistForm').reset();
    itensOrcamento = []; 
    renderizarTabela();  
    atualizarResumoVeiculo();
}

// ==========================================
// 5. PDF DEFINITIVO (A4 CENTRALIZADO)
// ==========================================
window.emitirOS = async function() {
    const getBase64ImageFromUrl = async (imageUrl) => {
        try {
            const res = await fetch(imageUrl);
            const blob = await res.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => resolve(null);
                reader.readAsDataURL(blob);
            });
        } catch (e) { return null; }
    };

    const getValue = (id) => document.getElementById(id)?.value || '';
    const getText = (id) => document.getElementById(id)?.innerText || '';

    const dados = {
        placa: getValue('placa').toUpperCase() || 'SEM-PLACA',
        modelo: getValue('modelo') || 'N√£o informado',
        chassi: getValue('chassi') || '',
        km: getValue('km_entrada') || '',
        data: getValue('data') || '',
        hora: getValue('hora') || '',
        cliente: getValue('nome_cliente') || '',
        doc: getValue('cpf_cnpj') || '',
        tel: getValue('celular_cliente') || '',
        endereco: getValue('endereco_cliente') || '',
        servicos_txt: getValue('servicos') || '',
        oficina: getText('nome-oficina') || 'OFICINA',
        sub: getText('subtitulo-oficina') || '',
        tel_oficina: getText('telefone-oficina') || '',
        end_oficina: getText('endereco-oficina') || ''
    };

    const itensChecklist = [];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        if (['equipamentos','caracteristicas','cambio','tracao'].includes(cb.name)) {
            const label = document.querySelector(`label[for="${cb.id}"]`)?.innerText || cb.value;
            itensChecklist.push(label);
        }
    });

    let htmlChecklist = itensChecklist.length ? 
        `<div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; margin-bottom: 20px;">
            ${itensChecklist.map(i => `<div style="background:#f0f0f0; padding:4px 8px; border-radius:4px; border:1px solid #ccc;">‚úÖ ${i}</div>`).join('')}
        </div>` : 
        `<p style="font-size: 11px; color: #999; font-style: italic;">Nenhum item marcado.</p>`;

    let logoSrc = '';
    const imgElement = document.getElementById('logo-oficina');
    if (imgElement && imgElement.src) logoSrc = await getBase64ImageFromUrl(imgElement.src) || imgElement.src;

    let htmlItens = '';
    let total = 0;
    (typeof itensOrcamento !== 'undefined' ? itensOrcamento : []).forEach(item => {
        htmlItens += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 6px;">${item.descricao}</td>
                <td style="padding: 6px; text-align: center;">${(item.tipo === 'peca' ? 'PE√áA' : 'SERV')}</td>
                <td style="padding: 6px; text-align: right;">R$ ${parseFloat(item.valor).toFixed(2)}</td>
            </tr>`;
        total += parseFloat(item.valor);
    });

    if (!htmlItens) htmlItens = '<tr><td colspan="3" style="text-align:center; padding:10px; color:#999;">Nenhum item lan√ßado.</td></tr>';

    const conteudoPDF = `
    <div id="folha-a4" style="font-family: Arial, sans-serif; background: #fff; width: 100%; box-sizing: border-box; padding: 40px; color: #333;">
        <table style="width: 100%; border-bottom: 3px solid #cc0000; margin-bottom: 20px; padding-bottom: 10px;">
            <tr>
                <td style="width: 120px; vertical-align: middle;">${logoSrc ? `<img src="${logoSrc}" style="max-height: 80px; max-width: 100%;">` : ''}</td>
                <td style="text-align: right; vertical-align: middle;">
                    <h2 style="margin: 0; color: #cc0000; text-transform: uppercase; font-size: 20px;">${dados.oficina}</h2>
                    <p style="margin: 2px 0; font-size: 11px; color: #666;">${dados.sub}</p>
                    <p style="margin: 2px 0; font-size: 12px; font-weight: bold;">${dados.tel_oficina}</p>
                    <p style="margin: 2px 0; font-size: 11px;">${dados.end_oficina}</p>
                </td>
            </tr>
        </table>
        <div style="background: #f4f4f4; padding: 10px; border-left: 6px solid #cc0000; display: flex; justify-content: space-between; margin-bottom: 20px;">
            <strong style="font-size: 16px;">ORDEM DE SERVI√áO</strong>
            <strong style="color: #cc0000; font-size: 18px;">${dados.placa}</strong>
        </div>
        <table style="width: 100%; margin-bottom: 20px; font-size: 12px;">
            <tr>
                <td style="width: 50%; vertical-align: top; padding-right: 20px;">
                    <h3 style="margin:0 0 5px 0; color: #cc0000; border-bottom: 1px solid #ccc; font-size: 12px;">CLIENTE</h3>
                    <div style="margin-bottom: 4px;"><strong>Nome:</strong> ${dados.cliente}</div>
                    <div style="margin-bottom: 4px;"><strong>Doc:</strong> ${dados.doc}</div>
                    <div style="margin-bottom: 4px;"><strong>Tel:</strong> ${dados.tel}</div>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <h3 style="margin:0 0 5px 0; color: #cc0000; border-bottom: 1px solid #ccc; font-size: 12px;">VE√çCULO</h3>
                    <div style="margin-bottom: 4px;"><strong>Modelo:</strong> ${dados.modelo}</div>
                    <div style="margin-bottom: 4px;"><strong>KM:</strong> ${dados.km}</div>
                    <div style="margin-bottom: 4px;"><strong>Entrada:</strong> ${dados.data} ${dados.hora}</div>
                </td>
            </tr>
        </table>
        <div style="margin-bottom: 20px;">
            <h3 style="font-size: 12px; background: #eee; padding: 5px; margin-bottom: 0;">SERVI√áOS SOLICITADOS</h3>
            <div style="border: 1px solid #ddd; padding: 10px; font-size: 11px; min-height: 40px; border-radius: 4px;">${dados.servicos_txt || 'Nenhuma observa√ß√£o.'}</div>
        </div>
        <div>
            <h3 style="font-size: 12px; background: #eee; padding: 5px; margin-bottom: 10px;">INSPE√á√ÉO DE ENTRADA</h3>
            ${htmlChecklist}
        </div>
        <div style="margin-bottom: 30px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: #333; color: white;">
                        <th style="padding: 8px; text-align: left;">DESCRI√á√ÉO</th>
                        <th style="padding: 8px; text-align: center; width: 60px;">TIPO</th>
                        <th style="padding: 8px; text-align: right; width: 100px;">VALOR</th>
                    </tr>
                </thead>
                <tbody>${htmlItens}</tbody>
                <tfoot>
                    <tr style="background: #f9f9f9; font-weight: bold;">
                        <td colspan="2" style="padding: 10px; text-align: right; border-top: 2px solid #ccc;">TOTAL:</td>
                        <td style="padding: 10px; text-align: right; border-top: 2px solid #ccc; color: #28a745; font-size: 14px;">R$ ${total.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div style="text-align: center; font-size: 10px; color: #999; margin-top: 50px; border-top: 1px solid #eee; padding-top: 10px;">Gerado em ${new Date().toLocaleString()}</div>
    </div>`;

    const overlay = document.createElement('div');
    Object.assign(overlay.style, {
        position: 'fixed', top: '0', left: '0', width: '100vw', height: '100vh',
        background: 'rgba(50,50,50,1)', zIndex: '9999999', overflow: 'auto',
        display: 'flex', justifyContent: 'center', alignItems: 'flex-start', padding: '20px'
    });

    const container = document.createElement('div');
    container.innerHTML = conteudoPDF;
    Object.assign(container.style, { width: '794px', minWidth: '794px', background: 'white', boxShadow: '0 0 15px rgba(0,0,0,0.5)' });

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    const msg = document.createElement('div');
    msg.innerText = "‚è≥ BAIXANDO PDF...";
    Object.assign(msg.style, {
        position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
        background: 'gold', padding: '10px 20px', fontWeight: 'bold', zIndex: '10000000', borderRadius: '5px'
    });
    document.body.appendChild(msg);

    const opt = {
        margin: 0,
        filename: `OS_${dados.placa}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    try {
        await new Promise(r => setTimeout(r, 1000));
        await html2pdf().set(opt).from(container).save();
    } catch (e) {
        alert('Erro: ' + e.message);
    } finally {
        document.body.removeChild(overlay);
        document.body.removeChild(msg);
    }
};

// --- IMPORTANTE: GARANTE QUE O BOT√ÉO ANTIGO FUNCIONE ---
window.gerarPDF = window.emitirOS;
function gerarPDF() {
  const elemento = document.querySelector('.container');
  const opt = {
    margin: 10,
    filename: 'checklist.pdf',
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(elemento).save();
}
 document.getElementById('resumoCombustivel').textContent = combustivel;
  document.getElementById('resumoComplexidade').textContent = complexidade;
}

</script>

<script>
// üîß FUN√á√ïES B√ÅSICAS - FUNCIONAM 100%
function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
}

function salvarChecklist() {
  const dados = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    if (!el.name && !el.id) return;
    const chave = el.name || el.id;
    if (el.type === 'checkbox') dados[chave] = el.checked;
    else if (el.type === 'radio' && el.checked) dados[chave] = el.value;
    else dados[chave] = el.value;
  });
  localStorage.setItem('checklistSalvo', JSON.stringify(dados));
  alert('‚úÖ SALVO!');
}

function gerarPDF() {
  const elemento = document.querySelector('.container');
  const opt = {
    margin: 10,
    filename: 'checklist.pdf',
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(elemento).save();
}

function limparFormulario() {
  if (confirm('Limpar tudo?')) {
    document.getElementById('checklistForm').reset();
    alert('üßπ Limpou!');
  }
}

// INICIALIZA
document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ JS CARREGADO!');
});
<script>
function gerarPDF() {
    // Pega placa primeiro (obrigat√≥rio)
    const placaEl = document.getElementById('placa');
    if (!placaEl || !placaEl.value) {
        alert('‚ùå Preencha a PLACA primeiro!');
        placaEl?.focus();
        return;
    }
    
    const elemento = document.getElementById('novo-checklist');
    html2pdf()
        .set({
            filename: `Checklist_${placaEl.value.toUpperCase()}.pdf`,
            margin: [15, 10, 10, 10],
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            html2canvas: { scale: 2, useCORS: true, logging: false }
        })
        .from(elemento)
        .save()
        .then(() => alert('‚úÖ PDF baixado!'))
        .catch(err => console.error(err));
}

// Bot√£o Salvar (voc√™ tem no hist√≥rico)
function salvarChecklist() {
    const dados = {};
    document.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
        if (el.type === 'checkbox') dados[el.name] = el.checked;
        else if (el.type === 'radio' && el.checked) dados[el.name] = el.value;
        else dados[el.name] = el.value;
    });
    localStorage.setItem('checklistSalvo', JSON.stringify(dados));
    alert('üíæ SALVO!');
}
</script>

</body>
</html>





