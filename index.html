<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Checklist de Oficina - App Offline com PDF">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="wizard.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
   <title id="titulo-pagina">Checklist de Entrada ‚Äì Oficina</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
       <div class="header">
    <div class="logo-container">
        <img id="logo-oficina" src="logo.png" alt="Logo da Oficina">
    </div>
    <div class="header-content">
        <!-- ‚úÖ NEUTRO - PREENCHER NO CONFIG.JS -->
        <h1 id="nome-oficina">OFICINA</h1>
        <p id="subtitulo-oficina">Checklist de entrada e inspe√ß√£o veicular</p>
        <div class="contato-info">
            <svg class="whatsapp-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#25D366" viewBox="0 0 16 16">
    <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
</svg>

            <span id="telefone-oficina">(00) 00000-0000</span>
        </div>
        <div class="endereco-oficina" id="endereco-oficina">
            ENDERE√áO DA OFICINA
        </div>

                <div class="status-sync">
                    <div class="sync-dot" id="syncStatus"></div>
                    <span id="syncText">Online</span>
                </div>
            </div>
            <div class="header-badge">v3.0 PRO</div>
        </div>
<div class="tabs">
    <button class="tab-button active" onclick="switchTab('novo-checklist')">‚ûï Novo Checklist</button>
    <button class="tab-button" onclick="switchTab('orcamento')">üí∞ Pe√ßas & Servi√ßos</button>
    <button class="tab-button" onclick="switchTab('fotos')">üì∏ Fotos</button>
    <button class="tab-button" onclick="switchTab('historico')">üìã Hist√≥rico</button>
    <button class="tab-button" onclick="switchTab('relatorios')">üìä Relat√≥rios</button>
</div>


        <!-- ABA PRINCIPAL - CHECKLIST -->
        <div id="novo-checklist" class="tab-content active">
            <div class="content">
                <div id="successMessage" class="alert alert-success"></div>
                <div id="errorMessage" class="alert alert-error"></div>
                <div id="infoMessage" class="alert alert-info"></div>

                <form id="checklistForm">
                    <div class="section-title">üìã INFORMA√á√ïES DO VE√çCULO</div>

                    <!-- RESUMO FIXO DO VE√çCULO (VISUAL) -->
                    <div class="veiculo-resumo" id="resumoVeiculoPrincipal">
                        <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca">-</strong></div>
                        <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo">-</strong></div>
                        <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi">-</strong></div>
                        <div class="veiculo-resumo-pill">KM Entrada: <strong id="resumoKmEntrada">-</strong></div>
                        <div class="veiculo-resumo-pill">Data Entrada: <strong id="resumoData">-</strong></div>
                        <div class="veiculo-resumo-pill">Hora Entrada: <strong id="resumoHora">-</strong></div>
                        <div class="veiculo-resumo-pill">Combust√≠vel: <strong id="resumoCombustivel">-</strong></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="placa">Placa *</label>
                            <input type="text" id="placa" name="placa" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="chassi">Chassi</label>
                            <input type="text" id="chassi" name="chassi" placeholder="17 d√≠gitos" maxlength="17">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modelo">Modelo</label>
                            <input type="text" id="modelo" name="modelo" placeholder="Ex: Fiat Uno">
                        </div>
                        <div class="form-group">
                            <label for="km_entrada">KM Entrada</label>
                            <input type="text" id="km_entrada" name="km_entrada" placeholder="150.000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="data">Data Entrada</label>
                            <input type="date" id="data" name="data">
                        </div>
                        <div class="form-group">
                            <label for="hora">Hora Entrada</label>
                            <input type="time" id="hora" name="hora">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="combustivel">N√≠vel Combust√≠vel</label>
                            <select id="combustivel" name="combustivel">
                                <option value="">Selecione...</option>
                                <option value="cheio">Cheio</option>
                                <option value="meio">Meio</option>
                                <option value="1/4">1/4</option>
                                <option value="vazio">Vazio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="km_saida">KM Sa√≠da</label>
                            <input type="text" id="km_saida" name="km_saida" placeholder="150.500">
                        </div>
                    </div>

                    <div class="section-title">üöó CARACTER√çSTICAS DO VE√çCULO</div>

                    <div class="equip-section">
                        <div class="equip-section-title">üîß ACESS√ìRIOS OBRIGAT√ìRIOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="estepe" name="equipamentos" value="ESTEPE"><label for="estepe">ESTEPE</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="macaco" name="equipamentos" value="MACACO"><label for="macaco">MACACO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="chave_roda" name="equipamentos" value="CHAVE DE RODA"><label for="chave_roda">CHAVE DE RODA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="triangulo" name="equipamentos" value="TRI√ÇNGULO"><label for="triangulo">TRI√ÇNGULO</label></div>
                        </div>
                    </div>

<div class="equip-section">
    <div class="equip-section-title">‚õΩ TIPO COMBUST√çVEL</div>
    <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="gasolina" name="equipamentos" value="GASOLINA"><label for="gasolina">GASOLINA</label></div>
        <div class="checkbox-item"><input type="checkbox" id="etanol" name="equipamentos" value="ETANOL"><label for="etanol">ETANOL</label></div>
        <div class="checkbox-item"><input type="checkbox" id="gnv" name="equipamentos" value="GNV"><label for="gnv">GNV</label></div>
        <div class="checkbox-item"><input type="checkbox" id="diesel" name="equipamentos" value="DIESEL"><label for="diesel">DIESEL</label></div>
    </div>
</div>



                    <div class="equip-section">
                        <div class="equip-section-title">üîä ELETR√îNICOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="radio" name="equipamentos" value="R√ÅDIO / MULTIM√çDIA"><label for="radio">R√ÅDIO / MULTIM√çDIA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="alarme_corta" name="equipamentos" value="ALARME / CORTA CORRENTE"><label for="alarme_corta">ALARME / CORTA CORRENTE</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="antena" name="equipamentos" value="ANTENA"><label for="antena">ANTENA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="acendedor" name="equipamentos" value="ACENDEDOR/TOMADA 12V"><label for="acendedor">ACENDEDOR/TOMADA 12V</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
                        <div class="equip-section-title">‚ö° EL√âTRICOS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="vidro_eletrico" name="equipamentos" value="VIDRO EL√âTRICO"><label for="vidro_eletrico">VIDRO EL√âTRICO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="trava_eletrica" name="equipamentos" value="TRAVA EL√âTRICA"><label for="trava_eletrica">TRAVA EL√âTRICA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="buzina" name="equipamentos" value="BUZINA"><label for="buzina">BUZINA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="bateria" name="equipamentos" value="BATERIA"><label for="bateria">BATERIA</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
                        <div class="equip-section-title">üõû RODAS & P√ÅRA-BRISAS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="calotas" name="equipamentos" value="CALOTAS"><label for="calotas">CALOTAS</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rodas_liga" name="equipamentos" value="RODAS DE LIGA"><label for="rodas_liga">RODAS DE LIGA</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="roda_ferro" name="equipamentos" value="RODA DE FERRO"><label for="roda_ferro">RODA DE FERRO</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="para_brisa" name="equipamentos" value="PARABRISA TRINCADO"><label for="para_brisa">P√ÅRA BRISA TRICADO</label></div>
                        </div>
                    </div>

                    <div class="equip-section">
    <div class="equip-section-title">üì¶ DEMAIS ACESS√ìRIOS</div>
    <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="extintor" name="equipamentos" value="EXTINTOR"><label for="extintor">EXTINTOR</label></div>
        <div class="checkbox-item"><input type="checkbox" id="protetor_carter" name="equipamentos" value="PROTETOR DE CARTER"><label for="protetor_carter">PROTETOR DE CARTER</label></div>
        <div class="checkbox-item"><input type="checkbox" id="chave_secreta" name="equipamentos" value="CHAVE SEGREDO (RODA)"><label for="chave_secreta">CHAVE SEGREDO (RODA)</label></div>
        <div class="checkbox-item"><input type="checkbox" id="tapetes" name="equipamentos" value="TAPETES"><label for="tapetes">TAPETES</label></div>
    </div>
</div>


                    <div class="equip-section">
                        <div class="equip-section-title">‚≠ê EQUIPAMENTOS PRINCIPAIS</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="ar" name="caracteristicas" value="AR"><label for="ar">AR</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="abs" name="caracteristicas" value="ABS"><label for="abs">ABS</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="airbag" name="caracteristicas" value="Air Bag"><label for="airbag">Air Bag</label></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>C√¢mbio</label>
                            <div class="checkbox-group" style="margin-top: 5px;">
                                <div class="checkbox-item"><input type="checkbox" id="cambio_auto" name="cambio" value="Autom√°tico"><label for="cambio_auto">Autom√°tico</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="cambio_manual" name="cambio" value="Manual"><label for="cambio_manual">Manual</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tra√ß√£o</label>
                            <div class="checkbox-group" style="margin-top: 5px;">
                                <div class="checkbox-item"><input type="checkbox" id="tracao_4x2" name="tracao" value="4x2"><label for="tracao_4x2">4x2</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="tracao_4x4" name="tracao" value="4x4"><label for="tracao_4x4">4x4</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">üë§ DADOS DO CLIENTE</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_cliente">Nome *</label>
                            <input type="text" id="nome_cliente" name="nome_cliente" placeholder="Nome completo do cliente">
                        </div>
                        <div class="form-group">
                            <label for="cpf_cnpj">CPF / CNPJ</label>
                            <input type="text" id="cpf_cnpj" name="cpf_cnpj" placeholder="000.000.000-00" maxlength="18">
                        </div>
                    </div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="endereco_cliente">Endere√ßo Completo</label>
                            <textarea id="endereco_cliente" name="endereco_cliente" placeholder="Rua, n√∫mero, bairro, cidade - UF, CEP" style="height: 60px; min-height: 60px;"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="celular_cliente">Celular / WhatsApp *</label>
                            <input type="tel" id="celular_cliente" name="celular_cliente" placeholder="(31) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label for="telefone2">Telefone 2 (opcional)</label>
                            <input type="tel" id="telefone2" name="telefone2" placeholder="(31) 9999-9999">
                        </div>
                    </div>

                    <div class="section-title">üîß SERVI√áOS/SOLICITADOS</div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="servicos">Descreva os servi√ßos solicitados:</label>
                            <textarea id="servicos" name="servicos" placeholder="Ex: Troca de √≥leo e filtro, alinhamento e balanceamento..."></textarea>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" class="btn-success" onclick="emitirOS()">üìÑ Baixar Ordem de Servi√ßo</button>
                        <button type="button" class="btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ABA HIST√ìRICO -->
        <div id="historico" class="tab-content">
            <div class="content">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por placa, modelo ou cliente..." onkeyup="filtrarChecklists()">
                    <button class="btn-secondary btn-small" onclick="ordenarChecklists()">üìä Ordenar</button>
                </div>

                <div id="checklistsList"></div>
                <div id="emptyMessage" style="text-align: center; padding: 40px; color: #999;">
                    <p style="font-size: 40px; margin-bottom: 10px;">üì≠</p>
                    <p>Nenhum checklist salvo ainda. Crie um novo para come√ßar!</p>
                </div>
            </div>
        </div>

        <!-- ABA RELAT√ìRIOS -->
        <div id="relatorios" class="tab-content">
            <div class="content">
                <div class="section-title">üìä ESTAT√çSTICAS GERAIS</div>
                <div class="stats-box">
                    <div class="stat-card">
                        <div class="stat-number" id="totalChecklists">0</div>
                        <div class="stat-label">Checklists Salvos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="checklistsMes">0</div>
                        <div class="stat-label">Checklists M√™s Atual</div>
                    </div>
                </div>

                <div class="section-title">üöó MARCAS MAIS ATENDIDAS</div>
                <div id="graficoMarcas" style="margin-top: 20px;"></div>

                <div class="action-buttons">
                    <button class="btn-primary" onclick="exportarDados()">üíæ Exportar Todos (JSON)</button>
                    <button class="btn-danger" onclick="limparTodosDados()">üóëÔ∏è Limpar Hist√≥rico</button>
                </div>
            </div>
        </div>

        <!-- ABA OR√áAMENTO ‚Äì PLANILHA DE PE√áAS & SERVI√áOS -->
        <div id="orcamento" class="tab-content">
            <div class="content">
                <div class="section-title">üí∞ PE√áAS & SERVI√áOS</div>

                <!-- RESUMO FIXO DO VE√çCULO TAMB√âM NA ABA DE PE√áAS -->
                <div class="veiculo-resumo" id="resumoVeiculoOrcamento">
                    <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca2">-</strong></div>
                    <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo2">-</strong></div>
                    <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi2">-</strong></div>
                    <div class="veiculo-resumo-pill">KM Entrada: <strong id="resumoKmEntrada2">-</strong></div>
                    <div class="veiculo-resumo-pill">Complexidade: <strong id="resumoComplexidade">-</strong></div>
                </div>

                <!-- COMPLEXIDADE -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="complexidade">Complexidade do evento</label>
                        <select id="complexidade" name="complexidade">
                            <option value="">Selecione...</option>
                            <option value="pequena monta">Pequena monta</option>
                            <option value="meia monta">Meia monta</option>
                            <option value="grande monta">Grande monta</option>
                        </select>
                    </div>
                </div>

              <!-- DENTRO DA DIV #orcamento -->

<!-- 1. Adicione a sele√ß√£o de Tipo (Pe√ßa ou Servi√ßo) no formul√°rio -->
<div class="form-row">
    <div class="form-group">
        <label>Tipo do Item:</label>
        <div class="checkbox-group" style="margin-top: 5px;">
            <div class="checkbox-item">
                <input type="radio" id="tipoPeca" name="tipoItem" value="peca" checked>
                <label for="tipoPeca">Pe√ßa</label>
            </div>
            <div class="checkbox-item">
                <input type="radio" id="tipoServico" name="tipoItem" value="servico">
                <label for="tipoServico">Servi√ßo</label>
            </div>
        </div>
    </div>
</div>

<div class="form-row two">
    <div class="form-group">
        <label for="descricaoItem">Descri√ß√£o</label>
        <input type="text" id="descricaoItem" placeholder="Ex: Pastilha de Freio / M√£o de obra">
    </div>
    <div class="form-group">
        <label for="valorItem">Valor (R$)</label>
        <input type="number" id="valorItem" step="0.01" min="0" placeholder="0,00">
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <button type="button" class="btn-primary" onclick="adicionarItemManual()">‚ûï Adicionar</button>
    </div>
</div>

<!-- 2. Substitua a tabela antiga por DUAS tabelas novas -->
<div style="margin-top:20px;">
    
    <!-- SE√á√ÉO DE PE√áAS -->
    <h4 style="border-bottom: 2px solid #e41616; padding-bottom: 5px; color: #333;">üî© Pe√ßas</h4>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom: 10px;">
        <thead>
            <tr style="background:#f7f7f7;">
                <th style="border:1px solid #ddd; padding:6px; text-align:left;">Descri√ß√£o</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width: 100px;">Valor</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width: 50px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaPecas"></tbody>
        <tfoot>
            <tr>
                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">Total Pe√ßas:</td>
                <td id="totalPecas" style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold; color: #e41616;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- SE√á√ÉO DE SERVI√áOS -->
    <h4 style="border-bottom: 2px solid #0056b3; padding-bottom: 5px; color: #333; margin-top: 25px;">üîß Servi√ßos</h4>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom: 10px;">
        <thead>
            <tr style="background:#f7f7f7;">
                <th style="border:1px solid #ddd; padding:6px; text-align:left;">Descri√ß√£o</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width: 100px;">Valor</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width: 50px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaServicos"></tbody>
        <tfoot>
            <tr>
                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">Total Servi√ßos:</td>
                <td id="totalServicos" style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold; color: #0056b3;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- TOTAL GERAL (SOMA DOS DOIS) -->
    <div style="background: #eee; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: right;">
        <span style="font-size: 14px; font-weight: bold; color: #555;">TOTAL GERAL (Pe√ßas + Servi√ßos):</span>
        <div id="totalGeralFinal" style="font-size: 24px; font-weight: bold; color: #28a745;">R$ 0,00</div>
    </div>

</div>
                <div class="action-buttons">
    <button type="button" class="btn-success" onclick="emitirOS()">üìÑ Baixar Ordem de Servi√ßo</button>
</div>
            </div>
        </div>
<!-- ABA FOTOS ‚úÖ PERFEITA -->
<div id="fotos" class="tab-content">
    <div class="content">
        <div class="section-title">üì∏ FOTOS DO VE√çCULO</div>
        
        <!-- RESUMO VE√çCULO -->
        <div class="veiculo-resumo" id="resumoVeiculoFotos">
            <div class="veiculo-resumo-pill">Placa: <strong id="resumoPlaca3">-</strong></div>
            <div class="veiculo-resumo-pill">Modelo: <strong id="resumoModelo3">-</strong></div>
            <div class="veiculo-resumo-pill">Chassi: <strong id="resumoChassi3">-</strong></div>
            <div class="veiculo-resumo-pill">KM: <strong id="resumoKmFotos">-</strong></div>
        </div>

        <!-- BOT√ïES -->
        <div class="form-row">
            <div class="form-group">
                <button type="button" class="btn-primary" onclick="iniciarCamera()">üì∑ Tirar Foto</button>
            </div>
            <div class="form-group">
                <input type="file" id="uploadFotos" multiple accept="image/*" onchange="adicionarFotos(event)">
                <label for="uploadFotos" class="btn-secondary" style="cursor:pointer; padding:12px 24px; display:block; text-align:center;">üìÅ Galeria</label>
            </div>
        </div>

        <!-- C√ÇMERA -->
        <div class="camera-container" style="display:none;">
            <video id="cameraPreview" autoplay playsinline style="width:100%; max-width:400px; height:300px; border-radius:12px; border:3px solid #e41616; background:#000;"></video>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                <button class="btn-success btn-small" onclick="tirarFoto()" id="btnTirarFoto" style="display:none;">üì∏ Capturar</button>
                <button class="btn-secondary btn-small" onclick="pararCamera()">‚ùå Cancelar</button>
            </div>
        </div>

        <!-- GALERIA -->
        <div class="section-title">Galeria de Fotos (M√°x 15)</div>
        <div id="galeriaFotos" class="fotos-grid"></div>

        <div class="action-buttons">
            <button type="button" class="btn-success" onclick="gerarPDFFotos()">üìÑ PDF Fotos</button>
            <button type="button" class="btn-danger" onclick="limparFotos()">üóëÔ∏è Limpar Fotos</button>
        </div>
    </div>
</div>

    </div>

    <script>
function salvarChecklist() {

    const dados = {};

    document.querySelectorAll('input, select, textarea').forEach(el => {

        if (!el.name && !el.id) return;

        const chave = el.name || el.id;

        if (el.type === 'checkbox') {
            dados[chave] = el.checked;
        } else if (el.type === 'radio') {
            if (el.checked) dados[chave] = el.value;
        } else {
            dados[chave] = el.value;
        }
    });

    // pe√ßas adicionadas dinamicamente
    dados.pecas = [];
    document.querySelectorAll('.linha-peca').forEach(linha => {
        const peca = {};
        linha.querySelectorAll('input, select').forEach(campo => {
            peca[campo.name || campo.className] = campo.value;
        });
        dados.pecas.push(peca);
    });

    // fotos
    dados.fotos = [];
    document.querySelectorAll('#previewFotos img').forEach(img => {
        dados.fotos.push(img.src);
    });

    // salvar local
    localStorage.setItem('checklistSalvo', JSON.stringify(dados));

    alert('Checklist salvo com sucesso.');
}

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active');
            });

            if (tabId === 'historico') carregarHistorico();
            if (tabId === 'relatorios') atualizarRelatorios();
            if (tabId === 'orcamento') atualizarResumoVeiculo(); // garante resumo atualizado ao abrir Pe√ßas
        }

        function salvarChecklist() {
            const placa = document.getElementById('placa').value;
            if (!placa) {
                alert("Por favor, preencha pelo menos a PLACA para salvar.");
                return;
            }

            const formData = {};
            const elements = document.getElementById('checklistForm').elements;

            for (let i = 0; i < elements.length; i++) {
                const item = elements[i];
                if (item.name) {
                    if (item.type === 'checkbox') {
                        if (item.checked) {
                            if (!formData[item.name]) formData[item.name] = [];
                            formData[item.name].push(item.value);
                        }
                    } else if (item.type !== 'button') {
                        formData[item.name] = item.value;
                    }
                }
            }

            const checklist = {
                id: Date.now(),
                data_criacao: new Date().toISOString(),
                ...formData
            };

            let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            checklists.push(checklist);
            localStorage.setItem('checklists', JSON.stringify(checklists));

            alert("‚úÖ Checklist salvo com sucesso no Hist√≥rico!");
            document.getElementById('checklistForm').reset();
            atualizarResumoVeiculo();
            switchTab('historico');
        }

        function carregarHistorico() {
            const listaDiv = document.getElementById('checklistsList');
            const emptyMsg = document.getElementById('emptyMessage');
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');

            listaDiv.innerHTML = '';

            if (checklists.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            checklists.slice().reverse().forEach(item => {
                const dataFormatada = new Date(item.data_criacao).toLocaleDateString('pt-BR');
                const horaFormatada = new Date(item.data_criacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                const card = document.createElement('div');
                card.className = 'checklist-item';
                card.innerHTML = `
                    <div class="checklist-info">
                        <h4>${(item.placa || '').toUpperCase()} - ${item.modelo || 'Modelo n√£o inf.'}</h4>
                        <p>üìÖ ${dataFormatada} √†s ${horaFormatada} | üë§ ${item.nome_cliente || 'Cliente n√£o inf.'}</p>
                    </div>
                    <div class="checklist-actions">
                        <button class="btn-small btn-secondary" onclick="carregarChecklist(${item.id})">‚úèÔ∏è Editar</button>
                        <button class="btn-small btn-danger" onclick="excluirChecklist(${item.id})">üóëÔ∏è</button>
                    </div>
                `;
                listaDiv.appendChild(card);
            });
        }

        function carregarChecklist(id) {
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            const item = checklists.find(c => c.id === id);

            if (item) {
                switchTab('novo-checklist');

                for (const key in item) {
                    const el = document.getElementsByName(key)[0];
                    if (el && el.type !== 'checkbox' && el.type !== 'file') {
                        el.value = item[key];
                    }
                }

                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

                if (item.equipamentos) item.equipamentos.forEach(val => marcarCheckbox('equipamentos', val));
                if (item.caracteristicas) item.caracteristicas.forEach(val => marcarCheckbox('caracteristicas', val));
                if (item.cambio) item.cambio.forEach(val => marcarCheckbox('cambio', val));
                if (item.tracao) item.tracao.forEach(val => marcarCheckbox('tracao', val));

                atualizarResumoVeiculo();
            }
        }

        function marcarCheckbox(name, value) {
            const els = document.getElementsByName(name);
            els.forEach(el => { if (el.value === value) el.checked = true; });
        }

        function excluirChecklist(id) {
            if (confirm("Tem certeza que deseja excluir este checklist?")) {
                let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
                checklists = checklists.filter(c => c.id !== id);
                localStorage.setItem('checklists', JSON.stringify(checklists));
                carregarHistorico();
            }
        }

        function filtrarChecklists() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            const listaDiv = document.getElementById('checklistsList');
            const emptyMsg = document.getElementById('emptyMessage');

            listaDiv.innerHTML = '';

            const filtrados = checklists.filter(item => {
                const texto = ((item.placa || '') + ' ' + (item.modelo || '') + ' ' + (item.nome_cliente || '')).toLowerCase();
                return texto.includes(termo);
            });

            if (!filtrados.length) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            filtrados.slice().reverse().forEach(item => {
                const dataFormatada = new Date(item.data_criacao).toLocaleDateString('pt-BR');
                const horaFormatada = new Date(item.data_criacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                const card = document.createElement('div');
                card.className = 'checklist-item';
                card.innerHTML = `
                    <div class="checklist-info">
                        <h4>${(item.placa || '').toUpperCase()} - ${item.modelo || 'Modelo n√£o inf.'}</h4>
                        <p>üìÖ ${dataFormatada} √†s ${horaFormatada} | üë§ ${item.nome_cliente || 'Cliente n√£o inf.'}</p>
                    </div>
                    <div class="checklist-actions">
                        <button class="btn-small btn-secondary" onclick="carregarChecklist(${item.id})">‚úèÔ∏è Editar</button>
                        <button class="btn-small btn-danger" onclick="excluirChecklist(${item.id})">üóëÔ∏è</button>
                    </div>
                `;
                listaDiv.appendChild(card);
            });
        }

        function ordenarChecklists() {
            const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
            checklists.sort((a, b) => {
                const placaA = (a.placa || '').toUpperCase();
                const placaB = (b.placa || '').toUpperCase();
                if (placaA < placaB) return -1;
                if (placaA > placaB) return 1;
                return 0;
            });
            localStorage.setItem('checklists', JSON.stringify(checklists));
            carregarHistorico();
        }

        function gerarPDF() {
            const elemento = document.querySelector('.container');

            const originalBodyOverflow = document.body.style.overflow;
            const originalBodyPadding = document.body.style.padding;
            const originalContainerMargin = elemento.style.margin;
            const originalContainerBoxShadow = elemento.style.boxShadow;

            window.scrollTo(0, 0);
            document.body.style.overflow = 'visible';
            document.body.style.padding = '0';
            elemento.style.margin = '0 auto';
            elemento.style.boxShadow = 'none';

            const botoes = document.querySelectorAll('button, .tabs, .header-badge, .action-buttons');
            botoes.forEach(btn => btn.style.display = 'none');

            const opt = {
                margin:       [0, 0, 0, 0],
                filename:     'Checklist-' + document.getElementById('placa').value + '.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  {
                    scale: 2,
                    useCORS: true,
                    scrollY: 0,
windowWidth: document.documentElement.offsetWidth
},
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(elemento).save().then(() => {
                botoes.forEach(btn => btn.style.display = '');
                document.querySelector('.tabs').style.display = 'flex';
                document.querySelector('.header-badge').style.display = 'block';
                document.querySelectorAll('.action-buttons').forEach(ab => ab.style.display = 'flex');

                document.body.style.overflow = originalBodyOverflow;
                document.body.style.padding = originalBodyPadding;
                elemento.style.margin = originalContainerMargin;
                elemento.style.boxShadow = originalContainerBoxShadow;
            }).catch(err => {
                console.error(err);
                alert("Erro ao gerar PDF.");
                botoes.forEach(btn => btn.style.display = '');
                document.querySelector('.tabs').style.display = 'flex';
                document.querySelector('.header-badge').style.display = 'block';
                document.querySelectorAll('.action-buttons').forEach(ab => ab.style.display = 'flex');
                document.body.style.overflow = originalBodyOverflow;
                document.body.style.padding = originalBodyPadding;
            });
        }

        function limparFormulario() {
            if (confirm("Limpar todos os campos do formul√°rio?")) {
                document.getElementById('checklistForm').reset();
                atualizarResumoVeiculo();
            }
        }

        function exportarDados() {
            const db = JSON.parse(localStorage.getItem('checklists') || '[]');
            if (!db.length) {
                alert("N√£o h√° dados para exportar.");
                return;
            }
            const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checklists.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function limparTodosDados() {
            if (confirm("Deseja apagar TODO o hist√≥rico?")) {
                localStorage.removeItem('checklists');
                carregarHistorico();
                alert("Hist√≥rico limpo.");
            }
        }

        function atualizarRelatorios() {
            const db = JSON.parse(localStorage.getItem('checklists') || '[]');

            document.getElementById('totalChecklists').textContent = db.length;

            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const doMes = db.filter(item => {
                if (!item.data_criacao) return false;
                const dataItem = new Date(item.data_criacao);
                return dataItem.getMonth() === mesAtual && dataItem.getFullYear() === anoAtual;
            });
            document.getElementById('checklistsMes').textContent = doMes.length;

            const marcas = {};
            db.forEach(item => {
                const modeloTexto = item.modelo || 'N√£o Informado';
                const m = modeloTexto.split(' ')[0].toUpperCase();
                marcas[m] = (marcas[m] || 0) + 1;
            });

            const sortedMarcas = Object.entries(marcas).sort((a,b) => b[1] - a[1]).slice(0, 5);
            let htmlGrafico = '';
            sortedMarcas.forEach(([marca, qtd]) => {
                const pct = (qtd / db.length) * 100;
                htmlGrafico += `
                    <div style="margin-bottom: 10px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                            <strong>${marca}</strong>
                            <span>${qtd}</span>
                        </div>
                        <div style="background:#eee; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="background:var(--color-primary); width:${pct}%; height:100%;"></div>
                        </div>
                    </div>
                `;
            });

            if (!sortedMarcas.length) {
                htmlGrafico = '<p style="text-align:center; color:#999; font-size:12px;">Sem dados suficientes.</p>';
            }

            document.getElementById('graficoMarcas').innerHTML = htmlGrafico;
        }

// OR√áAMENTO - PE√áAS & SERVI√áOS - SEPARADOS
let itensOrcamento = [];

function adicionarItemManual() {
    const descricaoInput = document.getElementById('descricaoItem');
    const valorInput = document.getElementById('valorItem');
    
    // Captura qual tipo foi selecionado (radio button)
    const tipo = document.querySelector('input[name="tipoItem"]:checked').value; 

    const descricao = descricaoInput.value.trim();
    const valor = parseFloat(valorInput.value || '0');

    if (!descricao) {
        alert('Informe a descri√ß√£o do item.');
        descricaoInput.focus();
        return;
    }
    if (isNaN(valor) || valor < 0) {
        alert('Informe um valor v√°lido.');
        valorInput.focus();
        return;
    }

    const item = {
        id: Date.now(),
        descricao,
        valor,
        tipo // salva 'peca' ou 'servico'
    };

    itensOrcamento.push(item);
    renderizarTabela();
    
    descricaoInput.value = '';
    valorInput.value = '';
    descricaoInput.focus();
}

function removerItem(id) {
    itensOrcamento = itensOrcamento.filter(i => i.id !== id);
    renderizarTabela();
}

function renderizarTabela() {
    const tbodyPecas = document.getElementById('tabelaPecas');
    const tbodyServicos = document.getElementById('tabelaServicos');
    
    const elTotalPecas = document.getElementById('totalPecas');
    const elTotalServicos = document.getElementById('totalServicos');
    const elTotalGeral = document.getElementById('totalGeralFinal');

    // Limpa tabelas
    if(tbodyPecas) tbodyPecas.innerHTML = '';
    if(tbodyServicos) tbodyServicos.innerHTML = '';

    let somaPecas = 0;
    let somaServicos = 0;

    itensOrcamento.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="border:1px solid #ddd; padding:6px;">${item.descricao}</td>
          <td style="border:1px solid #ddd; padding:6px; text-align:right;">R$ ${item.valor.toFixed(2)}</td>
          <td style="border:1px solid #ddd; padding:6px; text-align:center;">
            <button class="btn-small btn-danger" onclick="removerItem(${item.id})">üóëÔ∏è</button>
          </td>
        `;

        if (item.tipo === 'servico') {
            somaServicos += item.valor;
            if(tbodyServicos) tbodyServicos.appendChild(tr);
        } else {
            // Default √© pe√ßa
            somaPecas += item.valor;
            if(tbodyPecas) tbodyPecas.appendChild(tr);
        }
    });

    // Atualiza totais na tela
    if(elTotalPecas) elTotalPecas.textContent = 'R$ ' + somaPecas.toFixed(2);
    if(elTotalServicos) elTotalServicos.textContent = 'R$ ' + somaServicos.toFixed(2);
    
    const somaTotal = somaPecas + somaServicos;
    if(elTotalGeral) elTotalGeral.textContent = 'R$ ' + somaTotal.toFixed(2);
}

        // ENTER nos campos de Pe√ßas & Servi√ßos adiciona linha
        document.addEventListener('DOMContentLoaded', () => {
            carregarHistorico();
            atualizarResumoVeiculo();

            const descricaoItem = document.getElementById('descricaoItem');
            const valorItem = document.getElementById('valorItem');

            descricaoItem.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    adicionarItemManual();
                }
            });

            valorItem.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    adicionarItemManual();
                }
            });

            const camposResumo = ['placa','modelo','chassi','km_entrada','data','hora','combustivel','complexidade'];
            camposResumo.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const tipo = (el.tagName === 'SELECT' || el.type === 'date' || el.type === 'time') ? 'change' : 'input';
                el.addEventListener(tipo, atualizarResumoVeiculo);
            });
        });

        function atualizarResumoVeiculo() {
            const placa = document.getElementById('placa').value || '-';
            const modelo = document.getElementById('modelo').value || '-';
            const chassi = document.getElementById('chassi').value || '-';
            const kmEntrada = document.getElementById('km_entrada').value || '-';
            const data = document.getElementById('data').value || '-';
            const hora = document.getElementById('hora').value || '-';
            const combustivel = document.getElementById('combustivel').value || '-';
            const complexidade = document.getElementById('complexidade').value || '-';

            document.getElementById('resumoPlaca').textContent = placa;
            document.getElementById('resumoModelo').textContent = modelo;
            document.getElementById('resumoChassi').textContent = chassi;
            document.getElementById('resumoKmEntrada').textContent = kmEntrada;
            document.getElementById('resumoData').textContent = data;
            document.getElementById('resumoHora').textContent = hora;
            document.getElementById('resumoCombustivel').textContent = combustivel;

            document.getElementById('resumoPlaca2').textContent = placa;
            document.getElementById('resumoModelo2').textContent = modelo;
            document.getElementById('resumoChassi2').textContent = chassi;
            document.getElementById('resumoKmEntrada2').textContent = kmEntrada;
            document.getElementById('resumoComplexidade').textContent = complexidade || '-';
// FOTOS
const resumoPlaca3 = document.getElementById('resumoPlaca3');
const resumoModelo3 = document.getElementById('resumoModelo3');
const resumoChassi3 = document.getElementById('resumoChassi3');
const resumoKmFotos = document.getElementById('resumoKmFotos');
if (resumoPlaca3) resumoPlaca3.textContent = placa;
if (resumoModelo3) resumoModelo3.textContent = modelo;
if (resumoChassi3) resumoChassi3.textContent = chassi;
if (resumoKmFotos) resumoKmFotos.textContent = kmEntrada;

        }
// ========================================
// FOTOS - 100% FUNCIONAL
// ========================================
let streamCamera = null;
let fotosVeiculo = JSON.parse(localStorage.getItem('fotosVeiculo') || '[]');

function iniciarCamera() {
    const video = document.getElementById('cameraPreview');
    const btnTirar = document.getElementById('btnTirarFoto');
    const container = document.querySelector('.camera-container');
    
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    }).then(stream => {
        streamCamera = stream;
        video.srcObject = stream;
        container.style.display = 'block';
        btnTirar.style.display = 'inline-block';
        video.play();
    }).catch(err => {
        alert('Erro c√¢mera: ' + err.message + '\nUse "Galeria"');
    });
}

function tirarFoto() {
    const video = document.getElementById('cameraPreview');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    const foto = {
        id: Date.now(),
        dataURL: canvas.toDataURL('image/jpeg', 0.8),
        data: new Date().toLocaleString('pt-BR')
    };
    
    fotosVeiculo.unshift(foto);
    if (fotosVeiculo.length > 15) fotosVeiculo = fotosVeiculo.slice(0, 15);
    localStorage.setItem('fotosVeiculo', JSON.stringify(fotosVeiculo));
    renderizarGaleria();
    pararCamera();
}

function pararCamera() {
    if (streamCamera) {
        streamCamera.getTracks().forEach(track => track.stop());
        streamCamera = null;
    }
    document.querySelector('.camera-container').style.display = 'none';
    document.getElementById('btnTirarFoto').style.display = 'none';
}

function adicionarFotos(event) {
    const files = Array.from(event.target.files);
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            fotosVeiculo.unshift({
                id: Date.now() + Math.random(),
                dataURL: e.target.result,
                data: new Date().toLocaleString('pt-BR')
            });
            if (fotosVeiculo.length > 15) fotosVeiculo = fotosVeiculo.slice(0, 15);
            localStorage.setItem('fotosVeiculo', JSON.stringify(fotosVeiculo));
            renderizarGaleria();
        };
        reader.readAsDataURL(file);
    });
    event.target.value = '';
}

function renderizarGaleria() {
    const galeria = document.getElementById('galeriaFotos');
    if (!galeria) return;
    galeria.innerHTML = '';
    
    if (fotosVeiculo.length === 0) {
        galeria.innerHTML = '<p style="text-align:center;color:#999;padding:40px">üì≠ Nenhuma foto</p>';
        return;
    }
    
    fotosVeiculo.slice(0, 15).forEach((foto, index) => {
        const div = document.createElement('div');
        div.className = 'foto-item';
        div.innerHTML = `
            <img src="${foto.dataURL}" alt="Foto ${index + 1}" loading="lazy">
            <div class="foto-overlay"><span style="color:white;font-size:11px">${foto.data}</span></div>
            <div class="foto-actions">
                <button class="btn-foto btn-warning foto-zoom" data-url="${foto.dataURL}">üîç</button>
                <button class="btn-foto btn-danger foto-delete" data-id="${foto.id}">üóëÔ∏è</button>
            </div>
        `;
        galeria.appendChild(div);
    });
    
    // EVENTOS DELEGADOS
    galeria.querySelectorAll('.foto-zoom').forEach(btn => {
        btn.addEventListener('click', () => abrirFotoGrande(btn.dataset.url));
    });
    galeria.querySelectorAll('.foto-delete').forEach(btn => {
        btn.addEventListener('click', () => removerFoto(parseInt(btn.dataset.id)));
    });
}

function removerFoto(id) {
    fotosVeiculo = fotosVeiculo.filter(f => f.id !== id);
    localStorage.setItem('fotosVeiculo', JSON.stringify(fotosVeiculo));
    renderizarGaleria();
    mostrarAlerta('success', '‚úÖ Foto removida!');
}

function limparFotos() {
    if (confirm('üóëÔ∏è Limpar TODAS as fotos?')) {
        fotosVeiculo = [];
        localStorage.removeItem('fotosVeiculo');
        renderizarGaleria();
        mostrarAlerta('success', '‚úÖ Fotos limpas!');
    }
}

function abrirFotoGrande(dataURL) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position:fixed; top:0; left:0; width:100vw; height:100vh; 
        background:rgba(0,0,0,0.95); z-index:9999; display:flex; 
        align-items:center; justify-content:center; padding:20px;
    `;
    modal.innerHTML = `
        <img src="${dataURL}" style="max-width:95%; max-height:95%; border-radius:8px; box-shadow:0 0 50px rgba(255,255,255,0.3);">
        <button onclick="this.parentElement.remove()" style="
            position:absolute; top:20px; right:20px; background:#e41616; 
            color:white; border:none; border-radius:50%; width:50px; 
            height:50px; font-size:20px; cursor:pointer;
        ">‚úï</button>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function gerarPDFFotos() {
    if (!fotosVeiculo || fotosVeiculo.length === 0) {
        alert('üì≠ Sem fotos para gerar PDF');
        return;
    }

    const placa  = document.getElementById('placa')?.value  || 'SEM_PLACA';
    const modelo = document.getElementById('modelo')?.value || 'SEM_MODELO';
    const chassi = document.getElementById('chassi')?.value || 'SEM_CHASSI';

    const MAXFOTOS = 16;
    const fotosUsar = fotosVeiculo.slice(0, MAXFOTOS);

    let html = '';

    // Cada grupo de 4 fotos = 1 p√°gina (2x2)
    for (let i = 0; i < fotosUsar.length; i += 4) {
        const isLastGroup = i + 4 >= fotosUsar.length;

        html += `
            <div style="
                width: 100%;
                min-height: 100vh;
                box-sizing: border-box;
                padding: 20px;
                font-family: Arial, sans-serif;
                ${isLastGroup ? '' : 'page-break-after: always;'}
            ">
                <!-- CABE√áALHO COM DADOS DO CARRO -->
                <div style="
                    background: #f5f5f5;
                    border: 2px solid #e41616;
                    border-radius: 6px;
                    padding: 10px 15px;
                    margin-bottom: 15px;
                    font-size: 11px;
                    line-height: 1.5;
                ">
                    <div style="font-weight: bold; color: #e41616; font-size: 12px; margin-bottom: 5px;">- INSPE√á√ÉO DE FOTOS</div>
                    <div><strong>Placa:</strong> ${placa}</div>
                    <div><strong>Modelo:</strong> ${modelo}</div>
                    <div><strong>Chassi:</strong> ${chassi}</div>
                </div>

                <!-- GRADE DE 4 FOTOS 2x2 -->
                <div style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                ">
        `;

        for (let j = 0; j < 4 && (i + j) < fotosUsar.length; j++) {
            const foto = fotosUsar[i + j];
            const num = i + j + 1;

            html += `
                <div style="text-align: center;">
                    <img src="${foto.dataURL}"
                         style="
                             width: 100%;
                             max-width: 260px;
                             max-height: 260px;
                             height: auto;
                             border-radius: 6px;
                             border: 1px solid #e41616;
                         ">
                    <div style="
                        font-size: 9px;
                        margin-top: 5px;
                        color: #555;
                    ">
                        Foto ${num} - ${foto.data || ''}
                    </div>
                </div>
            `;
        }

        html += `
                </div>
            </div>
        `;
    }

    html2pdf().set({
        filename: `Fotos-${placa}.pdf`,
        margin: 0,
        image: { type: 'jpeg', quality: 0.9 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            scrollY: 0
        },
        jsPDF: {
            format: 'a4',
            orientation: 'portrait',
            unit: 'pt'
        }
    }).from(html).save();

    mostrarAlerta('success', `‚úÖ PDF gerado com ${fotosUsar.length} fotos (m√°ximo 16)`);
}

// INICIALIZAR FOTOS
document.addEventListener('DOMContentLoaded', () => {
    renderizarGaleria();
});

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,CmNvbnN0IENBQ0hFX05BTUUgPSAnY2hlY2tsaXN0LXYzLWNhY2hlJzsKY29uc3QgVVJMU19UT19DQUNIRSA9IFsKICAnLycsCiAgJy9pbmRleC5odG1sJwpdOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgKGV2ZW50KSA9PiB7CiAgY29uc3QgY2FjaGVPcGVuID0gY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkudGhlbigY2xpZW50KSA9PiB7CiAgICByZXR1cm4gY2xpZW50LmFkZEFsbChVUkxzX1RPX0NBQ0hFKTsKICB9KTsKICBldmVudC53YWl0VW50aWwoKGNhY2hlT3Blbik7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIChldmVudCkgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgIGlmIChyZXNwb25zZSkgewogICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAgfQogICAgICByZXR1cm4gZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgICB9KQogICk7Cn0pOwo=');
        }
    </script>
<button id="btnSalvarChecklist" onclick="salvarChecklist()">
    üíæ Salvar Checklist
</button>
<script src="config.js"></script>
<script src="app.js"></script>
<script src="wizard.js"></script>
<script src="os_system.js"></script>
<script src="setup_buttons.js"></script>
<script>
// ==========================================
// 1. VARI√ÅVEIS GLOBAIS
// ==========================================
let itensOrcamento = []; // Lista de pe√ßas/servi√ßos

// ==========================================
// 2. NAVEGA√á√ÉO ENTRE ABAS (FIXA)
// ==========================================
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

    const target = document.getElementById(tabId);
    if (target) {
        target.classList.add('active');
        
        // Ativa o bot√£o correspondente
        document.querySelectorAll('.tab-button').forEach(btn => {
            if (btn.getAttribute('onclick')?.includes(tabId)) {
                btn.classList.add('active');
            }
        });

        // A√ß√µes espec√≠ficas ao abrir abas
        if (tabId === 'historico') carregarHistorico();
        if (tabId === 'relatorios') atualizarRelatorios();
        if (tabId === 'orcamento') {
            atualizarResumoVeiculo();
            renderizarTabela(); // Garante que a tabela apare√ßa
        }
    }
}

// ==========================================
// 3. PE√áAS E SERVI√áOS (TABELA DUPLA)
// ==========================================
function adicionarItemManual() {
    const desc = document.getElementById('descricaoItem').value;
    const val = document.getElementById('valorItem').value;
    const tipo = document.querySelector('input[name="tipoItem"]:checked')?.value || 'peca';

    if (!desc || !val) {
        alert("Preencha descri√ß√£o e valor!");
        return;
    }

    itensOrcamento.push({
        id: Date.now(),
        descricao: desc.toUpperCase(),
        valor: parseFloat(val),
        tipo: tipo
    });

    renderizarTabela();
    
    document.getElementById('descricaoItem').value = '';
    document.getElementById('valorItem').value = '';
    document.getElementById('descricaoItem').focus();
}

function renderizarTabela() {
    const tbodyPecas = document.getElementById('tabelaPecas');
    const tbodyServicos = document.getElementById('tabelaServicos');
    
    if (!tbodyPecas || !tbodyServicos) return;

    tbodyPecas.innerHTML = '';
    tbodyServicos.innerHTML = '';
    
    let totalP = 0;
    let totalS = 0;

    itensOrcamento.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #eee';
        tr.innerHTML = `
            <td style="padding:8px;">${item.descricao}</td>
            <td style="padding:8px; text-align:right;">R$ ${item.valor.toFixed(2)}</td>
            <td style="padding:8px; text-align:center;">
                <button onclick="removerItem(${item.id})" style="background:none; border:none; cursor:pointer;">‚ùå</button>
            </td>
        `;

        if (item.tipo === 'peca') {
            tbodyPecas.appendChild(tr);
            totalP += item.valor;
        } else {
            tbodyServicos.appendChild(tr);
            totalS += item.valor;
        }
    });

    if (document.getElementById('totalPecas')) document.getElementById('totalPecas').innerText = `R$ ${totalP.toFixed(2)}`;
    if (document.getElementById('totalServicos')) document.getElementById('totalServicos').innerText = `R$ ${totalS.toFixed(2)}`;
    if (document.getElementById('totalGeralFinal')) document.getElementById('totalGeralFinal').innerText = `R$ ${(totalP + totalS).toFixed(2)}`;
}

function removerItem(id) {
    itensOrcamento = itensOrcamento.filter(i => i.id !== id);
    renderizarTabela();
}

// ==========================================
// 4. SALVAR E CARREGAR CHECKLIST
// ==========================================
function salvarChecklist() {
    const placa = document.getElementById('placa').value;
    if (!placa) {
        alert("Preencha a PLACA para salvar.");
        return;
    }

    const formData = {};
    document.querySelectorAll('input, select, textarea').forEach(el => {
        if (!el.name) return;
        if (el.type === 'checkbox') {
            if (el.checked) {
                if (!formData[el.name]) formData[el.name] = [];
                formData[el.name].push(el.value);
            }
        } else if (el.type !== 'radio' || el.checked) {
            formData[el.name] = el.value;
        }
    });

    const checklist = {
        id: Date.now(),
        data_criacao: new Date().toISOString(),
        itensOrcamento: itensOrcamento, // Salva o array global
        ...formData
    };

    let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
    checklists.push(checklist);
    localStorage.setItem('checklists', JSON.stringify(checklists));

    alert("‚úÖ Salvo com sucesso!");
    limparFormulario();
    switchTab('historico');
}

function carregarChecklist(id) {
    const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
    const item = checklists.find(c => c.id === id);

    if (item) {
        switchTab('novo-checklist');

        for (const key in item) {
            const el = document.getElementsByName(key)[0];
            if (el && el.type !== 'checkbox' && el.type !== 'file') {
                el.value = item[key];
            }
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        ['equipamentos', 'caracteristicas', 'cambio', 'tracao'].forEach(grupo => {
            if (item[grupo]) item[grupo].forEach(val => {
                const cb = document.querySelector(`input[name="${grupo}"][value="${val}"]`);
                if (cb) cb.checked = true;
            });
        });

        itensOrcamento = item.itensOrcamento || []; 
        renderizarTabela(); 
        atualizarResumoVeiculo();
    }
}

function limparFormulario() {
    document.getElementById('checklistForm').reset();
    itensOrcamento = []; 
    renderizarTabela();  
    atualizarResumoVeiculo();
}

// ==========================================
// 5. FUN√á√ïES AUXILIARES (HIST√ìRICO, RELAT√ìRIOS, ETC)
// ==========================================
function atualizarResumoVeiculo() {
    const placa = document.getElementById('placa').value || '-';
    const modelo = document.getElementById('modelo').value || '-';
    const chassi = document.getElementById('chassi').value || '-';
    const km = document.getElementById('km_entrada').value || '-';
    const data = document.getElementById('data').value || '-';
    const hora = document.getElementById('hora').value || '-';
    const combustivel = document.getElementById('combustivel').value || '-';

    ['resumoPlaca', 'resumoPlaca2', 'resumoPlaca3'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = placa; });
    ['resumoModelo', 'resumoModelo2', 'resumoModelo3'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = modelo; });
    
    if(document.getElementById('resumoChassi')) document.getElementById('resumoChassi').innerText = chassi;
    if(document.getElementById('resumoKmEntrada')) document.getElementById('resumoKmEntrada').innerText = km;
    if(document.getElementById('resumoData')) document.getElementById('resumoData').innerText = data;
    if(document.getElementById('resumoHora')) document.getElementById('resumoHora').innerText = hora;
    if(document.getElementById('resumoCombustivel')) document.getElementById('resumoCombustivel').innerText = combustivel;
}

function carregarHistorico() {
    const listaDiv = document.getElementById('checklistsList');
    const emptyMsg = document.getElementById('emptyMessage');
    const checklists = JSON.parse(localStorage.getItem('checklists') || '[]');

    if (!listaDiv) return;
    listaDiv.innerHTML = '';

    if (checklists.length === 0) {
        if (emptyMsg) emptyMsg.style.display = 'block';
        return;
    } else {
        if (emptyMsg) emptyMsg.style.display = 'none';
    }

    checklists.slice().reverse().forEach(item => {
        const dataFormatada = new Date(item.data_criacao).toLocaleDateString('pt-BR');
        const horaFormatada = new Date(item.data_criacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

        const card = document.createElement('div');
        card.className = 'checklist-item';
        card.innerHTML = `
            <div class="checklist-info">
                <h4>${(item.placa || '').toUpperCase()} - ${item.modelo || 'Modelo n√£o inf.'}</h4>
                <p>üìÖ ${dataFormatada} √†s ${horaFormatada} | üë§ ${item.nome_cliente || 'Cliente n√£o inf.'}</p>
            </div>
            <div class="checklist-actions">
                <button class="btn-small btn-secondary" onclick="carregarChecklist(${item.id})">‚úèÔ∏è Editar</button>
                <button class="btn-small btn-danger" onclick="excluirChecklist(${item.id})">üóëÔ∏è</button>
            </div>
        `;
        listaDiv.appendChild(card);
    });
}

function excluirChecklist(id) {
    if (confirm("Tem certeza que deseja excluir?")) {
        let checklists = JSON.parse(localStorage.getItem('checklists') || '[]');
        checklists = checklists.filter(c => c.id !== id);
        localStorage.setItem('checklists', JSON.stringify(checklists));
        carregarHistorico();
    }
}

function atualizarRelatorios() {
    // Implementa√ß√£o b√°sica de relat√≥rios para n√£o dar erro
    const db = JSON.parse(localStorage.getItem('checklists') || '[]');
    if(document.getElementById('totalChecklists')) document.getElementById('totalChecklists').innerText = db.length;
}

// ==========================================
// 6. GERADOR DE PDF (LAYOUT A4 CENTRALIZADO)
// ==========================================
window.emitirOS = async function() {
    const getBase64ImageFromUrl = async (imageUrl) => {
        try {
            const res = await fetch(imageUrl);
            const blob = await res.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => resolve(null);
                reader.readAsDataURL(blob);
            });
        } catch (e) { return null; }
    };

    const getValue = (id) => document.getElementById(id)?.value || '';
    const getText = (id) => document.getElementById(id)?.innerText || '';

    const dados = {
        placa: getValue('placa').toUpperCase() || 'SEM-PLACA',
        modelo: getValue('modelo') || 'N√£o informado',
        chassi: getValue('chassi') || '',
        km: getValue('km_entrada') || '',
        data: getValue('data') || '',
        hora: getValue('hora') || '',
        cliente: getValue('nome_cliente') || '',
        doc: getValue('cpf_cnpj') || '',
        tel: getValue('celular_cliente') || '',
        endereco: getValue('endereco_cliente') || '',
        servicos_txt: getValue('servicos') || '',
        oficina: getText('nome-oficina') || 'OFICINA',
        sub: getText('subtitulo-oficina') || '',
        tel_oficina: getText('telefone-oficina') || '',
        end_oficina: getText('endereco-oficina') || ''
    };

    const itensChecklist = [];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        if (['equipamentos','caracteristicas','cambio','tracao'].includes(cb.name)) {
            const label = document.querySelector(`label[for="${cb.id}"]`)?.innerText || cb.value;
            itensChecklist.push(label);
        }
    });

    let htmlChecklist = itensChecklist.length ? 
        `<div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; margin-bottom: 20px;">
            ${itensChecklist.map(i => `<div style="background:#f0f0f0; padding:4px 8px; border-radius:4px; border:1px solid #ccc;">‚úÖ ${i}</div>`).join('')}
        </div>` : 
        `<p style="font-size: 11px; color: #999; font-style: italic;">Nenhum item marcado.</p>`;

    let logoSrc = '';
    const imgElement = document.getElementById('logo-oficina');
    if (imgElement && imgElement.src) logoSrc = await getBase64ImageFromUrl(imgElement.src) || imgElement.src;

    let htmlItens = '';
    let total = 0;
    (typeof itensOrcamento !== 'undefined' ? itensOrcamento : []).forEach(item => {
        htmlItens += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 6px;">${item.descricao}</td>
                <td style="padding: 6px; text-align: center;">${(item.tipo === 'peca' ? 'PE√áA' : 'SERV')}</td>
                <td style="padding: 6px; text-align: right;">R$ ${parseFloat(item.valor).toFixed(2)}</td>
            </tr>`;
        total += parseFloat(item.valor);
    });

    if (!htmlItens) htmlItens = '<tr><td colspan="3" style="text-align:center; padding:10px; color:#999;">Nenhum item lan√ßado.</td></tr>';

    const conteudoPDF = `
    <div id="folha-a4" style="font-family: Arial, sans-serif; background: #fff; width: 100%; box-sizing: border-box; padding: 40px; color: #333;">
        <table style="width: 100%; border-bottom: 3px solid #cc0000; margin-bottom: 20px; padding-bottom: 10px;">
            <tr>
                <td style="width: 120px; vertical-align: middle;">${logoSrc ? `<img src="${logoSrc}" style="max-height: 80px; max-width: 100%;">` : ''}</td>
                <td style="text-align: right; vertical-align: middle;">
                    <h2 style="margin: 0; color: #cc0000; text-transform: uppercase; font-size: 20px;">${dados.oficina}</h2>
                    <p style="margin: 2px 0; font-size: 11px; color: #666;">${dados.sub}</p>
                    <p style="margin: 2px 0; font-size: 12px; font-weight: bold;">${dados.tel_oficina}</p>
                    <p style="margin: 2px 0; font-size: 11px;">${dados.end_oficina}</p>
                </td>
            </tr>
        </table>
        <div style="background: #f4f4f4; padding: 10px; border-left: 6px solid #cc0000; display: flex; justify-content: space-between; margin-bottom: 20px;">
            <strong style="font-size: 16px;">ORDEM DE SERVI√áO</strong>
            <strong style="color: #cc0000; font-size: 18px;">${dados.placa}</strong>
        </div>
        <table style="width: 100%; margin-bottom: 20px; font-size: 12px;">
            <tr>
                <td style="width: 50%; vertical-align: top; padding-right: 20px;">
                    <h3 style="margin:0 0 5px 0; color: #cc0000; border-bottom: 1px solid #ccc; font-size: 12px;">CLIENTE</h3>
                    <div style="margin-bottom: 4px;"><strong>Nome:</strong> ${dados.cliente}</div>
                    <div style="margin-bottom: 4px;"><strong>Doc:</strong> ${dados.doc}</div>
                    <div style="margin-bottom: 4px;"><strong>Tel:</strong> ${dados.tel}</div>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <h3 style="margin:0 0 5px 0; color: #cc0000; border-bottom: 1px solid #ccc; font-size: 12px;">VE√çCULO</h3>
                    <div style="margin-bottom: 4px;"><strong>Modelo:</strong> ${dados.modelo}</div>
                    <div style="margin-bottom: 4px;"><strong>KM:</strong> ${dados.km}</div>
                    <div style="margin-bottom: 4px;"><strong>Entrada:</strong> ${dados.data} ${dados.hora}</div>
                </td>
            </tr>
        </table>
        <div style="margin-bottom: 20px;">
            <h3 style="font-size: 12px; background: #eee; padding: 5px; margin-bottom: 0;">SERVI√áOS SOLICITADOS</h3>
            <div style="border: 1px solid #ddd; padding: 10px; font-size: 11px; min-height: 40px; border-radius: 4px;">${dados.servicos_txt || 'Nenhuma observa√ß√£o.'}</div>
        </div>
        <div>
            <h3 style="font-size: 12px; background: #eee; padding: 5px; margin-bottom: 10px;">INSPE√á√ÉO DE ENTRADA</h3>
            ${htmlChecklist}
        </div>
        <div style="margin-bottom: 30px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: #333; color: white;">
                        <th style="padding: 8px; text-align: left;">DESCRI√á√ÉO</th>
                        <th style="padding: 8px; text-align: center; width: 60px;">TIPO</th>
                        <th style="padding: 8px; text-align: right; width: 100px;">VALOR</th>
                    </tr>
                </thead>
                <tbody>${htmlItens}</tbody>
                <tfoot>
                    <tr style="background: #f9f9f9; font-weight: bold;">
                        <td colspan="2" style="padding: 10px; text-align: right; border-top: 2px solid #ccc;">TOTAL:</td>
                        <td style="padding: 10px; text-align: right; border-top: 2px solid #ccc; color: #28a745; font-size: 14px;">R$ ${total.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div style="text-align: center; font-size: 10px; color: #999; margin-top: 50px; border-top: 1px solid #eee; padding-top: 10px;">Gerado em ${new Date().toLocaleString()}</div>
    </div>`;

    const overlay = document.createElement('div');
    Object.assign(overlay.style, {
        position: 'fixed', top: '0', left: '0', width: '100vw', height: '100vh',
        background: 'rgba(50,50,50,1)', zIndex: '9999999', overflow: 'auto',
        display: 'flex', justifyContent: 'center', alignItems: 'flex-start', padding: '20px'
    });
    
    const container = document.createElement('div');
    container.innerHTML = conteudoPDF;
    Object.assign(container.style, { width: '794px', minWidth: '794px', background: 'white', boxShadow: '0 0 15px rgba(0,0,0,0.5)' });

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    const msg = document.createElement('div');
    msg.innerText = "‚è≥ BAIXANDO PDF...";
    Object.assign(msg.style, {
        position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
        background: 'gold', padding: '10px 20px', fontWeight: 'bold', zIndex: '10000000', borderRadius: '5px'
    });
    document.body.appendChild(msg);

    const opt = {
        margin: 0,
        filename: `OS_${dados.placa}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    try {
        await new Promise(r => setTimeout(r, 1000));
        await html2pdf().set(opt).from(container).save();
    } catch (e) {
        alert('Erro: ' + e.message);
    } finally {
        document.body.removeChild(overlay);
        document.body.removeChild(msg);
    }
};
    window.gerarPDF = window.emitirOS; 

</script>



</body>
</html>





